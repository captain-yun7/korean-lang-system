<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµ­ì–´ í•™ìŠµ í†µí•© ì‹œìŠ¤í…œ (v3 - Google Sheet Linked)</title>
    <link rel="manifest" href="manifest.json"> 
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 1400px;
            min-height: 80vh;
            overflow: hidden;
            position: relative; 
        }
        /* --- Loading Overlay --- */
        #loadingOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            color: #333;
            z-index: 2000; 
            display: none; 
        }
        #loadingOverlay.active {
            display: flex;
        }
        /* --- End Loading Overlay --- */

        /* ë¡œê·¸ì¸ í˜ì´ì§€ ìŠ¤íƒ€ì¼ */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            padding: 40px;
        }

        .login-box {
            width: 100%;
            max-width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #666;
            font-size: 1.1em;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-group label {
            color: #555;
            font-weight: 600;
            font-size: 0.95em;
        }

        .input-group input, .input-group select {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-btn {
            padding: 14px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .error-message {
            color: #e74c3c;
            text-align: center;
            padding: 10px;
            background: #ffe4e4;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        /* ë©”ì¸ í—¤ë” ìŠ¤íƒ€ì¼ */
        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: white;
            font-size: 1.8em;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
            color: white;
        }

        .user-info span {
            font-size: 1.1em;
        }

        .logout-btn {
            padding: 8px 20px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* íƒ­ ë©”ë‰´ ìŠ¤íƒ€ì¼ */
        .tab-menu {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
        }

        .tab-btn {
            padding: 15px 25px;
            background: none;
            border: none;
            color: #666;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            position: relative;
        }

        .tab-btn:hover {
            background: #f0f0f0;
        }

        .tab-btn.active {
            color: #667eea;
            background: white;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #667eea;
        }

        /* ì½˜í…ì¸  ì˜ì—­ */
        .content {
            padding: 30px;
            min-height: 500px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }

        .card:hover {
            box-shadow: 0 5px 20px rgba(0,0,0,0.12);
        }

        .card-title {
            color: #333;
            font-size: 1.4em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f7971e, #ffd200);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #eb3349, #f45c43);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #2196F3, #00BCD4);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        /* í¼ ìŠ¤íƒ€ì¼ */
        .form-group {
            margin-bottom: 20px;
        }

        .paragraph-block {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fdfdfd;
        }
        .paragraph-block label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }
        .paragraph-block textarea {
            min-height: 100px;
        }
        .paragraph-q-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .paragraph-q-group input {
            width: 50%;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        td button {
            margin-bottom: 5px;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* í†µê³„ ì¹´ë“œ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.12);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        /* ë…í•´ íƒ€ì´ë¨¸ */
        .timer-display {
            font-size: 3em;
            color: #667eea;
            text-align: center;
            margin: 30px 0;
            font-weight: bold;
        }

        .passage-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            margin: 20px 0;
            line-height: 1.8;
            font-size: 1.1em;
        }

        /* ë¬¸ì œ ìŠ¤íƒ€ì¼ */
        .question-card {
            background: white;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .passage-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        .passage-card h4 {
            font-size: 1.2em;
            color: #333;
        }
        .passage-card p {
            color: #666;
            margin: 10px 0;
        }
        .passage-card-actions {
            margin-top: 15px;
        }


        .question-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            background: #667eea;
            color: white;
            text-align: center;
            line-height: 30px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .options {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option:hover {
            background: #e8eaf6;
        }

        .option input[type="radio"] {
            margin-right: 10px;
        }

        /* ê²°ê³¼ í‘œì‹œ */
        .result-container {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-top: 30px;
        }

        .result-score {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .result-message {
            font-size: 1.2em;
        }

        /* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ */
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .container {
                border-radius: 0;
                min-height: 100vh;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .tab-menu {
                flex-wrap: wrap;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .timer-display {
                font-size: 2em;
            }
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ì•Œë¦¼ ë©”ì‹œì§€ */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        /* ëª¨ë‹¬ ë³¸ë¬¸ ì¤„ë°”ê¿ˆ ì ìš© */
        .modal-body {
            white-space: pre-wrap;
        }

        .modal-body form {
            white-space: normal;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5em;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <div id="loadingOverlay">
             <div class="loading"></div>&nbsp; ë°ì´í„°ë¥¼ ë¡œë“œ/ì €ì¥í•˜ëŠ” ì¤‘...
        </div>

        <div id="loginPage" class="login-container">
            <div class="login-box">
                <div class="login-header">
                    <h1>ğŸ“š êµ­ì–´ í•™ìŠµ ì‹œìŠ¤í…œ</h1>
                    <p>ë¡œê·¸ì¸í•˜ì—¬ í•™ìŠµì„ ì‹œì‘í•˜ì„¸ìš”</p>
                </div>
                <form class="login-form" onsubmit="handleLogin(event)">
                    <div class="input-group">
                        <label>ì‚¬ìš©ì ìœ í˜•</label>
                        <select id="userType">
                            <option value="student">í•™ìƒ</option>
                            <option value="teacher">êµì‚¬</option>
                        </select>
                    </div>
                    <div class="input-group" id="studentIdGroup">
                        <label>í•™ë²ˆ (ì˜ˆ: 030201)</label>
                        <input type="text" id="studentId" placeholder="3í•™ë…„ 2ë°˜ 1ë²ˆ â†’ 030201">
                    </div>
                    <div class="input-group">
                        <label>ì•„ì´ë””</label>
                        <input type="text" id="userId" required>
                    </div>
                    <div class="input-group">
                        <label>ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="password" required>
                    </div>
                    <button type="submit" class="login-btn">ë¡œê·¸ì¸</button>
                    <div id="errorMessage" class="error-message"></div>
                </form>
            </div>
        </div>

        <div id="teacherPage" style="display: none;">
            <div class="header">
                <h1>ğŸ“š êµ­ì–´ í•™ìŠµ ì‹œìŠ¤í…œ - êµì‚¬ìš©</h1>
                <div class="user-info">
                    <span id="teacherName"></span>
                    <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>

            <div class="tab-menu">
                <button class="tab-btn active" onclick="switchTab('dashboard', this)">ëŒ€ì‹œë³´ë“œ</button>
                <button class="tab-btn" onclick="switchTab('students', this)">í•™ìƒ ê´€ë¦¬</button>
                <button class="tab-btn" onclick="switchTab('passages', this)">ì§€ë¬¸ ê´€ë¦¬</button>
                <button class="tab-btn" onclick="switchTab('questions', this)">ë¬¸ì œ ê´€ë¦¬</button>
                <button class="tab-btn" onclick="switchTab('results', this)">ì„±ì  ì¡°íšŒ</button>
                <button class="tab-btn" onclick="switchTab('statistics', this)">í†µê³„ ë¶„ì„</button>
            </div>

            <div class="content">
                <div id="dashboard" class="tab-content active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalStudents">0</div>
                            <div class="stat-label">ì „ì²´ í•™ìƒ ìˆ˜</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalPassages">0</div>
                            <div class="stat-label">ë“±ë¡ëœ ì§€ë¬¸</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalQuestions">0</div>
                            <div class="stat-label">ë“±ë¡ëœ ë¬¸ì œ</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avgScore">0%</div>
                            <div class="stat-label">í‰ê·  ì„±ì </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">ìµœê·¼ í™œë™ (Google Sheet ì—°ë™ í›„ ë¹„í™œì„±í™”)</h3>
                        <div id="recentActivities">
                           <p style="color: grey;">(í™œë™ ë¡œê·¸ëŠ” Google Sheet ì—°ë™ ì‹œ ë³„ë„ë¡œ ê¸°ë¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)</p>
                        </div>
                    </div>
                </div>

                <div id="students" class="tab-content">
                    <div class="card">
                        <h3 class="card-title">í•™ìƒ ë“±ë¡</h3>
                        <form onsubmit="addStudent(event)">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div class="form-group">
                                    <label>í•™ë…„</label>
                                    <select id="grade">
                                        <option value="1">1í•™ë…„</option>
                                        <option value="2">2í•™ë…„</option>
                                        <option value="3">3í•™ë…„</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>ë°˜</label>
                                    <input type="number" id="class" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>ë²ˆí˜¸</label>
                                    <input type="number" id="number" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>ì´ë¦„</label>
                                    <input type="text" id="studentName" required>
                                </div>
                                <div class="form-group">
                                    <label>ì•„ì´ë””</label>
                                    <input type="text" id="studentUserId" required>
                                </div>
                                <div class="form-group">
                                    <label>ë¹„ë°€ë²ˆí˜¸</label>
                                    <input type="text" id="studentPassword" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">í•™ìƒ ë“±ë¡</button>
                        </form>
                    </div>

                    <div class="card">
                        <h3 class="card-title">í•™ìƒ ëª©ë¡</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>í•™ë²ˆ</th>
                                        <th>ì´ë¦„</th>
                                        <th>ì•„ì´ë””</th>
                                        <th>ê³„ì • ìƒíƒœ</th>
                                        <th>ì‘ì—…</th>
                                    </tr>
                                </thead>
                                <tbody id="studentList">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="passages" class="tab-content">
                    <div class="card">
                        <h3 class="card-title">ì§€ë¬¸ ë“±ë¡</h3>
                        <form onsubmit="addPassage(event)">
                            <div class="form-group">
                                <label>ì§€ë¬¸ ì œëª©</label>
                                <input type="text" id="passageTitle" required>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label>ì¹´í…Œê³ ë¦¬</label>
                                    <select id="passageCategory">
                                        <option value="ë¹„ë¬¸í•™">ë¹„ë¬¸í•™</option>
                                        <option value="ë¬¸í•™">ë¬¸í•™</option>
                                        <option value="ë¬¸ë²•">ë¬¸ë²•</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>ë‚œì´ë„</label>
                                    <select id="passageDifficulty">
                                        <option value="ì¤‘í•™êµ">ì¤‘í•™êµ</option>
                                        <option value="ê³ 1-2">ê³ 1-2</option>
                                        <option value="ê³ 3">ê³ 3</option>
                                    </select>
                                </div>
                            </div>

                            <hr style="margin: 20px 0;">
                            <label style="font-weight: 600; font-size: 1.1em; margin-bottom: 15px; display:block;">ë¬¸ë‹¨ë³„ ë‚´ìš© ë° ì§ˆë¬¸ ë“±ë¡</label>

                            <div id="passageParagraphsContainer">
                                <div class="paragraph-block">
                                    <label>1ë¬¸ë‹¨</label>
                                    <textarea class="para-content" placeholder="1ë¬¸ë‹¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”." required></textarea>
                                    <div class="paragraph-q-group">
                                        <input type="text" class="para-question" placeholder="ì´ ë¬¸ë‹¨ì˜ ì§ˆë¬¸ (ì˜ˆ: 1ë¬¸ë‹¨ì˜ í•µì‹¬ì–´ëŠ”?)">
                                        <input type="text" class="para-answer" placeholder="ì§ˆë¬¸ì˜ ì •ë‹µ (í•™ìƒì—ê² ë³´ì´ì§€ ì•ŠìŒ)">
                                    </div>
                                </div>
                            </div>

                            <button type="button" class="btn btn-secondary" onclick="addParagraphField()">ë¬¸ë‹¨ ì¶”ê°€</button>
                            <button type="submit" class="btn btn-primary">ì§€ë¬¸ ë“±ë¡</button>
                        </form>
                    </div>

                    <div class="card">
                        <h3 class="card-title">ì§€ë¬¸ ëª©ë¡</h3>
                        <div id="passageList">
                            </div>
                    </div>
                </div>

                <div id="questions" class="tab-content">
                    <div class="card">
                        <h3 class="card-title">ë¬¸ì œ ë“±ë¡</h3>
                        <form id="questionForm" onsubmit="addQuestion(event)">
                            <input type="hidden" id="editingQuestionId">

                            <div class="form-group">
                                <label>ì§€ë¬¸ ì„ íƒ</label>
                                <select id="questionPassage" required>
                                    <option value="none" selected>ì—†ìŒ (ë¬¸ë²•/ê°œë… ë¬¸ì œ)</option>
                                    </select>
                            </div>
                            <div class="form-group">
                                <label>ë¬¸ì œ ìœ í˜•</label>
                                <select id="questionType">
                                    <option value="ê°ê´€ì‹">ê°ê´€ì‹</option>
                                    <option value="ë‹¨ë‹µí˜•">ë‹¨ë‹µí˜•</option>
                                    <option value="ì„œìˆ í˜•">ì„œìˆ í˜•</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ë¬¸ì œ</label>
                                <textarea id="questionText" required></textarea>
                            </div>
                            <div id="optionsContainer" class="form-group">
                                <label>ì„ íƒì§€ (ê°ê´€ì‹)</label>
                                <input type="text" id="option1" placeholder="â‘  ë²ˆ">
                                <input type="text" id="option2" placeholder="â‘¡ ë²ˆ">
                                <input type="text" id="option3" placeholder="â‘¢ ë²ˆ">
                                <input type="text" id="option4" placeholder="â‘£ ë²ˆ">
                                <input type="text" id="option5" placeholder="â‘¤ ë²ˆ">
                            </div>
                            <div class="form-group">
                                <label>ì •ë‹µ (ê°ê´€ì‹ì€ ë²ˆí˜¸, ë‹¨ë‹µí˜•/ì„œìˆ í˜•ì€ ë‹µì•ˆ)</label>
                                <input type="text" id="answer" required>
                            </div>
                            <div class="form-group">
                                <label>í•´ì„¤</label>
                                <textarea id="explanation"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">ë¬¸ì œ ì €ì¥</button>
                            <button type="button" class="btn btn-secondary" onclick="resetQuestionForm()">ì·¨ì†Œ</button>
                        </form>
                    </div>

                    <div class="card">
                        <h3 class="card-title">ë¬¸ì œ ëª©ë¡</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ì§€ë¬¸</th>
                                        <th>ë¬¸ì œ</th>
                                        <th>ìœ í˜•</th>
                                        <th>ì •ë‹µ</th>
                                        <th>ì‘ì—…</th>
                                    </tr>
                                </thead>
                                <tbody id="questionList">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="results" class="tab-content">
                    <div class="card">
                        <h3 class="card-title">ì„±ì  ì¡°íšŒ</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>í•™ë²ˆ</th>
                                        <th>ì´ë¦„</th>
                                        <th>ì§€ë¬¸</th>
                                        <th>ë…í•´ ì‹œê°„</th>
                                        <th>ì •ë‹µë¥ </th>
                                        <th>ì œì¶œ ì‹œê°</th>
                                        <th>ìƒì„¸ë³´ê¸°</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsList">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="statistics" class="tab-content">
                    <div class="card">
                        <h3 class="card-title">í•™ê¸‰ë³„ ì„±ì  ë¶„í¬</h3>
                        <canvas id="classChart"></canvas>
                    </div>
                    <div class="card">
                        <h3 class="card-title">ë¶„ì•¼ë³„ í‰ê·  ì„±ì </h3>
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="studentPage" style="display: none;">
            <div class="header">
                <h1>ğŸ“š êµ­ì–´ í•™ìŠµ ì‹œìŠ¤í…œ - í•™ìƒìš©</h1>
                <div class="user-info">
                    <span id="studentInfo"></span>
                    <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>

            <div class="tab-menu">
                <button class="tab-btn active" onclick="switchStudentTab('study', this)">í•™ìŠµí•˜ê¸°</button>
                <button class="tab-btn" onclick="switchStudentTab('myResults', this)">ë‚´ ì„±ì </button>
                <button class="tab-btn" onclick="switchStudentTab('ranking', this)">ìˆœìœ„</button>
            </div>

            <div class="content">
                <div id="study" class="tab-content active">
                    <div class="card">
                        <h3 class="card-title">í•™ìŠµ ì„ íƒ</h3>
                        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="startReading()">ë…í•´ ì—°ìŠµ</button>
                            <button class="btn btn-success" onclick="startQuiz()">ë¬¸ë²•/ê°œë… í’€ê¸°</button>
                        </div>
                    </div>

                    <div id="readingArea" class="card" style="display: none;">
                        <h3 class="card-title">ë…í•´ ì—°ìŠµ</h3>
                        <div class="timer-display" id="timer">00:00</div>
                        <div class="passage-container" id="readingPassage">
                            </div>
                        <button class="btn btn-primary" onclick="finishReading()">ë…í•´ ì™„ë£Œ</button>
                    </div>

                    <div id="paragraphQuizArea" class="card" style="display: none;">
                        <h3 class="card-title">ë¬¸ë‹¨ë³„ ë‚´ìš© í™•ì¸</h3>
                        <p>ì§€ë¬¸ì˜ ê° ë¬¸ë‹¨ë³„ ì§ˆë¬¸ì— ë‹µí•˜ì„¸ìš”.</p>
                        <br>
                        <div id="paragraphQuizContainer">
                            </div>
                        <button class="btn btn-primary" onclick="submitParagraphQuiz()" style="margin-top: 20px;">
                            ì œì¶œ í›„ ë¬¸ì œ í’€ê¸°
                        </button>
                    </div>

                    <div id="quizArea" class="card" style="display: none;">
                        <h3 class="card-title">ë¬¸ì œ í’€ê¸°</h3>
                        <div id="quizContainer">
                            </div>
                        <button class="btn btn-success" onclick="submitQuiz()">ì œì¶œí•˜ê¸°</button>
                    </div>

                    <div id="resultArea" class="result-container" style="display: none;">
                        <div class="result-score" id="score"></div>
                        <div class="result-message" id="resultMessage"></div>
                        <button class="btn btn-primary" onclick="resetStudy()" style="margin-top: 20px;">ë‹¤ì‹œ í•™ìŠµí•˜ê¸°</button>
                    </div>
                </div>

                <div id="myResults" class="tab-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="myAvgScore">0%</div>
                            <div class="stat-label">í‰ê·  ì„±ì </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="myTotalStudy">0</div>
                            <div class="stat-label">í•™ìŠµ íšŸìˆ˜</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="myAvgTime">0ë¶„</div>
                            <div class="stat-label">í‰ê·  ë…í•´ ì‹œê°„</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="myRank">-</div>
                            <div class="stat-label">ì „ì²´ ìˆœìœ„</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">í•™ìŠµ ì´ë ¥</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ë‚ ì§œ</th>
                                        <th>ì§€ë¬¸</th>
                                        <th>ë…í•´ ì‹œê°„</th>
                                        <th>ì ìˆ˜</th>
                                        <th>ìƒíƒœ</th>
                                    </tr>
                                </thead>
                                <tbody id="myStudyHistory">
                                    </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">ì„±ì¥ ê·¸ë˜í”„</h3>
                        <canvas id="growthChart"></canvas>
                    </div>
                </div>

                <div id="ranking" class="tab-content">
                    <div class="card">
                        <h3 class="card-title">ğŸ† ì „ì²´ ìˆœìœ„</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ìˆœìœ„</th>
                                        <th>í•™ë²ˆ</th>
                                        <th>ì´ë¦„</th>
                                        <th>í‰ê·  ì ìˆ˜</th>
                                        <th>í•™ìŠµ íšŸìˆ˜</th>
                                    </tr>
                                </thead>
                                <tbody id="rankingList">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal" id="editModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="modalTitle"></h3>
                    <button class="close-btn" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body" id="modalBody">
                    </div>
            </div>
        </div>
    </div>

    <script>
        // --- Google Sheet Integration ---
        // ğŸš¨ ì¤‘ìš”: ì—¬ê¸°ì— ì„ ìƒë‹˜ì˜ ì›¹ ì•± URLì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw_RB6q2ergpy4FzDeyqJ6_nSmJRBSQ5AD6_o2qiL5QjI72ZBLetsqEx0JH9F4WwTozjQ/exec"; 
        const loadingOverlay = document.getElementById('loadingOverlay');

        async function callWebApp(action, payload = {}, method = 'GET') {
            loadingOverlay.classList.add('active'); 
            try {
                let url = WEB_APP_URL + '?action=' + action;
                let options = { method: 'GET', redirect: 'follow' };

                if (method === 'POST') {
                    // GAS POST request workaround: use GET with payload in URL
                    url = WEB_APP_URL + '?action=' + action + '&payload=' + encodeURIComponent(JSON.stringify(payload));
                    options = { method: 'GET', redirect: 'follow' }; 
                } else { 
                    if (Object.keys(payload).length > 0) {
                         url += '&payload=' + encodeURIComponent(JSON.stringify(payload));
                    }
                    options = { method: 'GET', redirect: 'follow' };
                }

                const response = await fetch(url, options);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();

                if (result.status === 'error') {
                    throw new Error(result.message);
                }
                
                loadingOverlay.classList.remove('active'); 
                return result;

            } catch (error) {
                console.error("Error calling Web App:", error);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: Failed to fetch / " + error.message);
                loadingOverlay.classList.remove('active'); 
                throw error;
            }
        }
        // --- End Google Sheet Integration ---


        // ë°ì´í„° ì €ì¥ì†Œ (Google Sheet ë°ì´í„°ë¥¼ ì„ì‹œ ì €ì¥í•˜ëŠ” ì—­í• )
        let sheetDB = {
             teachers: [ { id: 'teacher1', password: 'pass123', name: 'ê¹€ì„ ìƒ' } ], 
            students: [],
            passages: [],
            questions: [],
            results: []
        };

        // í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì
        let currentUser = null;

        // ë…í•´ íƒ€ì´ë¨¸ ë³€ìˆ˜
        let timerInterval = null;
        let startTime = null;
        let currentPassage = null;
        let currentQuestions = [];

        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
        async function loadInitialData() {
            try {
                const result = await callWebApp('loadDB');
                if (result.data) {
                    sheetDB.students = result.data.students || [];
                    sheetDB.passages = result.data.passages || [];
                    sheetDB.questions = result.data.questions || [];
                    sheetDB.results = result.data.results || [];
                } else {
                     sheetDB.students = [];
                     sheetDB.passages = [];
                     sheetDB.questions = [];
                     sheetDB.results = [];
                }
            } catch (error) {
                console.error("Failed to load initial data:", error);
                // alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
            }
        }


        // ë¡œê·¸ì¸ ì²˜ë¦¬
        function handleLogin(e) {
            e.preventDefault();

            const userType = document.getElementById('userType').value;
            const userId = document.getElementById('userId').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('errorMessage');
            errorMsg.style.display = 'none';

            if (userType === 'teacher') {
                const teacher = sheetDB.teachers.find(t => t.id === userId && t.password === password);
                if (teacher) {
                    currentUser = { type: 'teacher', ...teacher };
                    showTeacherPage();
                } else {
                    errorMsg.textContent = 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                    errorMsg.style.display = 'block';
                }
            } else {
                const studentId = document.getElementById('studentId').value;
                const student = sheetDB.students.find(s =>
                    s.studentId == studentId && s.userId == userId && s.password == password
                );
                if (student) {
                    if (String(student.isActive).toUpperCase() !== 'TRUE') {
                         errorMsg.textContent = 'ë¹„í™œì„±í™”ëœ ê³„ì •ì…ë‹ˆë‹¤. ì„ ìƒë‹˜ê»˜ ë¬¸ì˜í•˜ì„¸ìš”.';
                         errorMsg.style.display = 'block';
                         return;
                     }
                    currentUser = { type: 'student', ...student };
                    showStudentPage();
                } else {
                    errorMsg.textContent = 'í•™ë²ˆ, ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                    errorMsg.style.display = 'block';
                }
            }
        }

        // í•™ìƒ í•„ë“œ í† ê¸€
        function toggleStudentFields() {
            const userType = document.getElementById('userType').value;
            const studentIdGroup = document.getElementById('studentIdGroup');
            // display: flex ëŒ€ì‹  blockìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ë ˆì´ì•„ì›ƒ ë¬¸ì œ í•´ê²°
            studentIdGroup.style.display = userType === 'student' ? 'flex' : 'none';
            if (userType === 'student') {
                document.getElementById('studentId').required = true;
            } else {
                document.getElementById('studentId').required = false;
            }
        }

        // êµì‚¬ í˜ì´ì§€ í‘œì‹œ 
        function showTeacherPage() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('teacherPage').style.display = 'block';
            document.getElementById('teacherName').textContent = currentUser.name + ' ì„ ìƒë‹˜';
            updateTeacherDashboard();
            loadStudentList();
            loadPassageList();
            loadQuestionPassages();
            loadQuestionList();
        }

        // í•™ìƒ í˜ì´ì§€ í‘œì‹œ 
        function showStudentPage() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('studentPage').style.display = 'block';
            document.getElementById('studentInfo').textContent =
                `${currentUser.grade}í•™ë…„ ${currentUser.class}ë°˜ ${currentUser.number}ë²ˆ ${currentUser.name}`;
            updateStudentDashboard();
            loadMyResults(); 
            loadRanking();   
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            currentUser = null;
            document.getElementById('teacherPage').style.display = 'none';
            document.getElementById('studentPage').style.display = 'none';
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('userId').value = '';
            document.getElementById('password').value = '';
            document.getElementById('studentId').value = '';
            document.getElementById('userType').value = 'student';
            toggleStudentFields();
        }

        // êµì‚¬ìš© íƒ­ ì „í™˜
        function switchTab(tabId, btn) {
            document.querySelectorAll('#teacherPage .tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('#teacherPage .tab-btn').forEach(b => {
                b.classList.remove('active');
            });

            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');

            if (tabId === 'dashboard') updateTeacherDashboard();
            if (tabId === 'students') loadStudentList();
            if (tabId === 'passages') loadPassageList();
            if (tabId === 'questions') {
                loadQuestionPassages(); 
                loadQuestionList();     
                resetQuestionForm();
            }
            if (tabId === 'results') loadResults(); 
            // if (tabId === 'statistics') loadStatistics(); 
        }

        // í•™ìƒìš© íƒ­ ì „í™˜
        function switchStudentTab(tabId, btn) {
            document.querySelectorAll('#studentPage .tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('#studentPage .tab-btn').forEach(b => {
                b.classList.remove('active');
            });

            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');

            if (tabId === 'myResults') loadMyResults();
            if (tabId === 'ranking') loadRanking();
        }

        // êµì‚¬ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
        function updateTeacherDashboard() {
            document.getElementById('totalStudents').textContent = sheetDB.students.length;
            document.getElementById('totalPassages').textContent = sheetDB.passages.length;
            document.getElementById('totalQuestions').textContent = sheetDB.questions.length;

            const resultsWithScore = sheetDB.results.filter(r => r.score !== null && r.score !== ''); 
             if(resultsWithScore.length > 0) {
                 const totalScore = resultsWithScore.reduce((sum, r) => sum + Number(r.score), 0);
                 const avgScore = totalScore / resultsWithScore.length;
                 document.getElementById('avgScore').textContent = Math.round(avgScore) + '%';
             } else {
                 document.getElementById('avgScore').textContent = '0%';
             }

            document.getElementById('recentActivities').innerHTML = '<p style="color: grey;">(í™œë™ ë¡œê·¸ëŠ” Google Sheet ì—°ë™ ì‹œ ë³„ë„ë¡œ ê¸°ë¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)</p>';
        }

        // í•™ìƒ ì¶”ê°€
        async function addStudent(e) {
            e.preventDefault();

            const grade = document.getElementById('grade').value;
            const classNum = document.getElementById('class').value;
            const number = document.getElementById('number').value;
            const name = document.getElementById('studentName').value;
            const userId = document.getElementById('studentUserId').value;
            const password = document.getElementById('studentPassword').value;

            const studentId = '0' + grade + classNum.padStart(2, '0') + number.padStart(2, '0');

            if (sheetDB.students.some(s => s.studentId == studentId)) {
                alert('ì´ë¯¸ ë“±ë¡ëœ í•™ë²ˆì…ë‹ˆë‹¤.');
                return;
            }
            if (sheetDB.students.some(s => s.userId == userId)) {
                alert('ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.');
                return;
            }

            const student = {
                studentId, userId, password, name,
                grade: parseInt(grade),
                class: parseInt(classNum),
                number: parseInt(number),
                isActive: true,
                registeredAt: new Date().toLocaleString()
            };

            try {
                const result = await callWebApp('addStudent', student, 'POST');
                sheetDB.students.push(student);
                alert(`í•™ìƒì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\ní•™ë²ˆ: ${studentId}\nì•„ì´ë””: ${userId}\në¹„ë°€ë²ˆí˜¸: ${password}`);
                e.target.reset();
                loadStudentList(); 
                updateTeacherDashboard(); 
            } catch (error) {
                alert("í•™ìƒ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message);
            }
        }


        // í•™ìƒ ëª©ë¡ ë¡œë“œ 
        function loadStudentList() {
            const tbody = document.getElementById('studentList');
            const html = sheetDB.students.sort((a,b) => String(a.studentId).localeCompare(String(b.studentId))).map(s => {
                const isActive = String(s.isActive).toUpperCase() === 'TRUE';
                return `
                    <tr>
                        <td>${s.studentId}</td>
                        <td>${s.name}</td>
                        <td>${s.userId}</td>
                        <td>
                            ${isActive ?
                                '<span style="color:green; font-weight:bold;">í™œì„±</span>' :
                                '<span style="color:gray;">ë¹„í™œì„±</span>'}
                        </td>
                        <td>
                            <button class="btn btn-warning" onclick="editStudent('${s.studentId}')" style="font-size: 0.9em; padding: 5px 10px;">ìˆ˜ì •</button>
                            <button class="btn ${isActive ? 'btn-secondary' : 'btn-success'}" onclick="toggleStudentStatus('${s.studentId}')" style="font-size: 0.9em; padding: 5px 10px;">
                                ${isActive ? 'ë¹„í™œì„±' : 'í™œì„±'}
                            </button>
                            <button class="btn btn-danger" onclick="deleteStudent('${s.studentId}')" style="font-size: 0.9em; padding: 5px 10px;">ì‚­ì œ</button>
                        </td>
                    </tr>
            `}).join('');
            tbody.innerHTML = html || '<tr><td colspan="5">ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        }

        // í•™ìƒ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸° 
        function editStudent(studentId) {
            const student = sheetDB.students.find(s => s.studentId == studentId);
            if (!student) return;

            document.getElementById('modalTitle').textContent = 'í•™ìƒ ì •ë³´ ìˆ˜ì •';
            document.getElementById('modalBody').innerHTML = `
                <form id="editStudentForm" onsubmit="saveStudent(event, '${student.studentId}')">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>í•™ë²ˆ</label>
                            <input type="text" id="editStudentId" value="${student.studentId}" disabled>
                        </div>
                        <div class="form-group">
                            <label>í•™ë…„</label>
                            <input type="number" id="editGrade" value="${student.grade}" required>
                        </div>
                        <div class="form-group">
                            <label>ë°˜</label>
                            <input type="number" id="editClass" value="${student.class}" required>
                        </div>
                        <div class="form-group">
                            <label>ë²ˆí˜¸</label>
                            <input type="number" id="editNumber" value="${student.number}" required>
                        </div>
                        <div class="form-group">
                            <label>ì´ë¦„</label>
                            <input type="text" id="editStudentName" value="${student.name}" required>
                        </div>
                        <div class="form-group">
                            <label>ì•„ì´ë””</label>
                            <input type="text" id="editStudentUserId" value="${student.userId}" required>
                        </div>
                        <div class="form-group">
                            <label>ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="text" id="editStudentPassword" value="${student.password}" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">ì €ì¥</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                </form>
            `;
            document.getElementById('editModal').classList.add('active');
        }

        // í•™ìƒ ì •ë³´ ì €ì¥
        async function saveStudent(e, originalStudentId) {
             e.preventDefault();
             const studentIndex = sheetDB.students.findIndex(s => s.studentId == originalStudentId);
             if (studentIndex === -1) {
                 alert("ìˆ˜ì •í•  í•™ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                 return;
             }
             const originalStudent = sheetDB.students[studentIndex];


             const newGrade = document.getElementById('editGrade').value;
             const newClass = document.getElementById('editClass').value;
             const newNumber = document.getElementById('editNumber').value;
             const newStudentId = '0' + newGrade + newClass.padStart(2, '0') + newNumber.padStart(2, '0');
             const newUserId = document.getElementById('editStudentUserId').value;
             const newName = document.getElementById('editStudentName').value;
             const newPassword = document.getElementById('editStudentPassword').value;

             if (newStudentId != originalStudentId && sheetDB.students.some(s => s.studentId == newStudentId)) {
                 alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í•™ë²ˆì…ë‹ˆë‹¤.');
                 return;
             }
             if (newUserId != originalStudent.userId && sheetDB.students.some(s => s.userId == newUserId)) {
                 alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.');
                 return;
             }

            const updatedStudentData = {
                originalStudentId: originalStudentId, 
                studentId: newStudentId,
                userId: newUserId,
                password: newPassword,
                name: newName,
                grade: parseInt(newGrade),
                class: parseInt(newClass),
                number: parseInt(newNumber),
                isActive: originalStudent.isActive 
            };

            try {
                await callWebApp('saveStudent', updatedStudentData, 'POST');
                sheetDB.students[studentIndex] = { ...updatedStudentData, registeredAt: originalStudent.registeredAt }; 
                
                loadStudentList(); 
                closeModal();
                alert('í•™ìƒ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                alert("í•™ìƒ ì •ë³´ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message);
            }
        }


        // í•™ìƒ ê³„ì • ìƒíƒœ í† ê¸€
        async function toggleStudentStatus(studentId) {
            const studentIndex = sheetDB.students.findIndex(s => s.studentId == studentId);
            if (studentIndex === -1) return;

             const currentStatus = String(sheetDB.students[studentIndex].isActive).toUpperCase() === 'TRUE';
             const studentName = sheetDB.students[studentIndex].name; 

            try {
                const result = await callWebApp('toggleStudentStatus', { studentId: studentId }, 'POST');
                
                 sheetDB.students[studentIndex].isActive = !currentStatus;

                loadStudentList(); 
                
                const status = !currentStatus ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”';
                 console.log(`${studentName} í•™ìƒ ê³„ì •ì´ ${status}ë˜ì—ˆìŠµë‹ˆë‹¤.`); 
            } catch (error) {
                alert("ê³„ì • ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message);
            }
        }


        // í•™ìƒ ì‚­ì œ
        async function deleteStudent(studentId) {
             const studentName = sheetDB.students.find(s => s.studentId == studentId)?.name || studentId;
             if (confirm(`'${studentName}' í•™ìƒì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì„±ì  ê¸°ë¡ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤)`)) {
                try {
                    await callWebApp('deleteStudent', { studentId: studentId }, 'POST');
                    
                     sheetDB.students = sheetDB.students.filter(s => s.studentId != studentId);
                     sheetDB.results = sheetDB.results.filter(r => r.studentId != studentId); 

                    loadStudentList(); 
                    updateTeacherDashboard(); 
                    loadResults(); 

                    console.log(`í•™ìƒ(${studentId})ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                } catch (error) {
                    alert("í•™ìƒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message);
                }
            }
        }

        // ë¬¸ë‹¨ ì…ë ¥ í•„ë“œ ì¶”ê°€
        function addParagraphField() {
            const container = document.getElementById('passageParagraphsContainer');
            const newIndex = container.children.length + 1;

            const div = document.createElement('div');
            div.className = 'paragraph-block';
            div.innerHTML = `
                <label>${newIndex}ë¬¸ë‹¨</label>
                <textarea class="para-content" placeholder="${newIndex}ë¬¸ë‹¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”." required></textarea>
                <div class="paragraph-q-group">
                    <input type="text" class="para-question" placeholder="ì´ ë¬¸ë‹¨ì˜ ì§ˆë¬¸">
                    <input type="text" class="para-answer" placeholder="ì§ˆë¬¸ì˜ ì •ë‹µ">
                </div>
            `;
            container.appendChild(div);
        }

        // ì§€ë¬¸ ì¶”ê°€
        async function addPassage(e) {
            e.preventDefault();

            const contentBlocks = [];
            const paraBlocks = document.querySelectorAll('#passageParagraphsContainer .paragraph-block');

            for(let block of paraBlocks) {
                const para = block.querySelector('.para-content').value;
                const q = block.querySelector('.para-question').value;
                const a = block.querySelector('.para-answer').value;

                if (para) {
                    contentBlocks.push({ para, q, a });
                }
            }

            if (contentBlocks.length === 0) {
                alert('í•˜ë‚˜ ì´ìƒì˜ ë¬¸ë‹¨ ë‚´ìš©ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            const passage = {
                id: Date.now(), 
                title: document.getElementById('passageTitle').value,
                category: document.getElementById('passageCategory').value,
                difficulty: document.getElementById('passageDifficulty').value,
                contentBlocks: contentBlocks,
                createdAt: new Date().toLocaleString()
            };

            try {
                await callWebApp('addPassage', passage, 'POST');
                
                sheetDB.passages.push(passage);

                alert('ì§€ë¬¸ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                e.target.reset();
                document.getElementById('passageParagraphsContainer').innerHTML = `
                    <div class="paragraph-block">
                        <label>1ë¬¸ë‹¨</label>
                        <textarea class="para-content" placeholder="1ë¬¸ë‹¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”." required></textarea>
                        <div class="paragraph-q-group">
                            <input type="text" class="para-question" placeholder="ì´ ë¬¸ë‹¨ì˜ ì§ˆë¬¸ (ì˜ˆ: 1ë¬¸ë‹¨ì˜ í•µì‹¬ì–´ëŠ”?)">
                            <input type="text" class="para-answer" placeholder="ì§ˆë¬¸ì˜ ì •ë‹µ (í•™ìƒì—ê² ë³´ì´ì§€ ì•ŠìŒ)">
                        </div>
                    </div>
                `;
                loadPassageList(); 
                updateTeacherDashboard(); 
                loadQuestionPassages(); 

            } catch (error) {
                alert("ì§€ë¬¸ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message);
            }
        }


        // ì§€ë¬¸ ëª©ë¡ ë¡œë“œ
        function loadPassageList() {
            const container = document.getElementById('passageList');
            const html = sheetDB.passages.map(p => {
                 let blocks = [];
                 if (typeof p.contentBlocks === 'string') {
                     try { blocks = JSON.parse(p.contentBlocks); } catch (e) { blocks = []; }
                 } else if (Array.isArray(p.contentBlocks)) {
                     blocks = p.contentBlocks;
                 }
                 const preview = blocks[0] ? blocks[0].para.substring(0, 100) : "ë‚´ìš© ì—†ìŒ";

                return `
                <div class="passage-card">
                    <h4>${p.title}</h4>
                    <p>ì¹´í…Œê³ ë¦¬: ${p.category} | ë‚œì´ë„: ${p.difficulty} | ë¬¸ë‹¨ ìˆ˜: ${blocks.length}</p>
                    <p style="color: #888;">${preview}...</p>
                    <div class="passage-card-actions">
                        <button class="btn btn-info" onclick="viewPassage(${p.id})">ë‚´ìš© ë³´ê¸°</button>
                        <button class="btn btn-warning" onclick="editPassage(${p.id})">ìˆ˜ì •</button>
                        <button class="btn btn-danger" onclick="deletePassage(${p.id})">ì‚­ì œ</button>
                    </div>
                </div>
            `}).join('');
            container.innerHTML = html || '<p>ë“±ë¡ëœ ì§€ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        // ì§€ë¬¸ ë‚´ìš© ë³´ê¸° ëª¨ë‹¬ í•¨ìˆ˜
        function viewPassage(id) {
            const passage = sheetDB.passages.find(p => p.id == id);
            if (!passage) return;

             let blocks = [];
             if (typeof passage.contentBlocks === 'string') {
                 try { blocks = JSON.parse(passage.contentBlocks); } catch (e) { blocks = []; }
             } else {
                 blocks = passage.contentBlocks || [];
             }

            document.getElementById('modalTitle').textContent = passage.title;
            const fullContent = blocks.map(b => b.para).join('\n\n');
            document.getElementById('modalBody').textContent = fullContent;
            document.getElementById('editModal').classList.add('active');
        }

        // ì§€ë¬¸ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸° 
        function editPassage(id) {
            const passage = sheetDB.passages.find(p => p.id == id);
            if (!passage) return;

             let blocks = [];
             if (typeof passage.contentBlocks === 'string') {
                 try { blocks = JSON.parse(passage.contentBlocks); } catch (e) { blocks = []; }
             } else {
                 blocks = passage.contentBlocks || [];
             }


            document.getElementById('modalTitle').textContent = 'ì§€ë¬¸ ìˆ˜ì •';

            const paragraphsHtml = blocks.map((block, index) => `
                <div class="paragraph-block">
                    <label>${index + 1}ë¬¸ë‹¨</label>
                    <textarea class="para-content" placeholder="${index + 1}ë¬¸ë‹¨ ë‚´ìš©" required>${block.para}</textarea>
                    <div class="paragraph-q-group">
                        <input type="text" class="para-question" placeholder="ì´ ë¬¸ë‹¨ì˜ ì§ˆë¬¸" value="${block.q || ''}">
                        <input type="text" class="para-answer" placeholder="ì§ˆë¬¸ì˜ ì •ë‹µ" value="${block.a || ''}">
                    </div>
                </div>
            `).join('');

            document.getElementById('modalBody').innerHTML = `
                <form id="editPassageForm" onsubmit="savePassage(event, ${id})">
                     <div class="form-group">
                        <label>ì§€ë¬¸ ì œëª©</label>
                        <input type="text" id="editPassageTitle" value="${passage.title}" required>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>ì¹´í…Œê³ ë¦¬</label>
                            <select id="editPassageCategory">
                                <option value="ë¹„ë¬¸í•™" ${passage.category === 'ë¹„ë¬¸í•™' ? 'selected' : ''}>ë¹„ë¬¸í•™</option>
                                <option value="ë¬¸í•™" ${passage.category === 'ë¬¸í•™' ? 'selected' : ''}>ë¬¸í•™</option>
                                <option value="ë¬¸ë²•" ${passage.category === 'ë¬¸ë²•' ? 'selected' : ''}>ë¬¸ë²•</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ë‚œì´ë„</label>
                            <select id="editPassageDifficulty">
                                <option value="ì¤‘í•™êµ" ${passage.difficulty === 'ì¤‘í•™êµ' ? 'selected' : ''}>ì¤‘í•™êµ</option>
                                <option value="ê³ 1-2" ${passage.difficulty === 'ê³ 1-2' ? 'selected' : ''}>ê³ 1-2</option>
                                <option value="ê³ 3" ${passage.difficulty === 'ê³ 3' ? 'selected' : ''}>ê³ 3</option>
                            </select>
                        </div>
                    </div>
                    <hr style="margin: 20px 0;">
                    <label style="font-weight: 600; font-size: 1.1em; margin-bottom: 15px; display:block;">ë¬¸ë‹¨ë³„ ë‚´ìš© ë° ì§ˆë¬¸</label>
                    <div id="editPassageParagraphsContainer">
                        ${paragraphsHtml}
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addEditParagraphField()">ë¬¸ë‹¨ ì¶”ê°€</button>
                    <button type="submit" class="btn btn-primary">ì§€ë¬¸ ì €ì¥</button>
                </form>
            `;
            document.getElementById('editModal').classList.add('active');
        }

        // (ìˆ˜ì • ëª¨ë‹¬ìš©) ë¬¸ë‹¨ ì¶”ê°€
        function addEditParagraphField() {
             const container = document.getElementById('editPassageParagraphsContainer');
             const newIndex = container.children.length + 1;

             const div = document.createElement('div');
             div.className = 'paragraph-block';
             div.innerHTML = `
                 <label>${newIndex}ë¬¸ë‹¨</label>
                 <textarea class="para-content" placeholder="${newIndex}ë¬¸ë‹¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”." required></textarea>
                 <div class="paragraph-q-group">
                     <input type="text" class="para-question" placeholder="ì´ ë¬¸ë‹¨ì˜ ì§ˆë¬¸">
                     <input type="text" class="para-answer" placeholder="ì§ˆë¬¸ì˜ ì •ë‹µ">
                 </div>
             `;
             container.appendChild(div);
         }


        // ì§€ë¬¸ ìˆ˜ì • ì €ì¥
        async function savePassage(e, id) {
            e.preventDefault();
            const passageIndex = sheetDB.passages.findIndex(p => p.id == id);
            if (passageIndex === -1) {
                 alert("ìˆ˜ì •í•  ì§€ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                 return;
            }

            const contentBlocks = [];
            const paraBlocks = document.querySelectorAll('#editPassageParagraphsContainer .paragraph-block');

            for(let block of paraBlocks) {
                const para = block.querySelector('.para-content').value;
                const q = block.querySelector('.para-question').value;
                const a = block.querySelector('.para-answer').value;

                if (para) {
                    contentBlocks.push({ para, q, a });
                }
            }

            if (contentBlocks.length === 0) {
                alert('í•˜ë‚˜ ì´ìƒì˜ ë¬¸ë‹¨ ë‚´ìš©ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

             const updatedPassageData = {
                 id: id, 
                 title: document.getElementById('editPassageTitle').value,
                 category: document.getElementById('editPassageCategory').value,
                 difficulty: document.getElementById('editPassageDifficulty').value,
                 contentBlocks: contentBlocks
             };


            try {
                 await callWebApp('savePassage', updatedPassageData, 'POST');
                 
                 sheetDB.passages[passageIndex] = { ...updatedPassageData, createdAt: sheetDB.passages[passageIndex].createdAt }; 

                 loadPassageList(); 
                 closeModal();
                 alert('ì§€ë¬¸ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
             } catch (error) {
                 alert("ì§€ë¬¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message);
             }
        }


        // ì§€ë¬¸ ì‚­ì œ
        async function deletePassage(id) {
            const passageTitle = sheetDB.passages.find(p => p.id == id)?.title || id;
            if (confirm(`'${passageTitle}' ì§€ë¬¸ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì—°ê²°ëœ ë¬¸ì œë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤)`)) {
                 try {
                     await callWebApp('deletePassage', { id: id }, 'POST');
                     
                     sheetDB.passages = sheetDB.passages.filter(p => p.id != id);
                     sheetDB.questions = sheetDB.questions.filter(q => q.passageId != id); 

                     loadPassageList(); 
                     loadQuestionPassages(); 
                     loadQuestionList(); 
                     updateTeacherDashboard(); 

                     console.log(`ì§€ë¬¸(${id})ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                 } catch (error) {
                     alert("ì§€ë¬¸ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message);
                 }
            }
        }

        // ë¬¸ì œìš© ì§€ë¬¸ ëª©ë¡ ë¡œë“œ
        function loadQuestionPassages() {
            const select = document.getElementById('questionPassage');
             const options = sheetDB.passages.map(p =>
                `<option value="${p.id}">${p.title}</option>`
            ).join('');
            select.innerHTML = '<option value="none" selected>ì—†ìŒ (ë¬¸ë²•/ê°œë… ë¬¸ì œ)</option>' + options;
        }

        // ë¬¸ì œ ìœ í˜•(ê°ê´€ì‹)ì— ë”°ë¥¸ ì„ íƒì§€ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°
        function toggleQuestionOptions() {
            const type = document.getElementById('questionType').value;
            document.getElementById('optionsContainer').style.display = (type === 'ê°ê´€ì‹') ? 'flex' : 'none';
            document.getElementById('optionsContainer').style.flexDirection = 'column';
        }
        
        // ë¬¸ì œ ë“±ë¡ í¼ ì´ˆê¸°í™”
        function resetQuestionForm() {
            document.getElementById('questionForm').reset();
            document.getElementById('editingQuestionId').value = '';
            document.getElementById('questionPassage').disabled = false;
            document.querySelector('#questionForm button[type="submit"]').textContent = 'ë¬¸ì œ ì €ì¥';
            toggleQuestionOptions();
        }

        // ë¬¸ì œ ì¶”ê°€ (ë° ìˆ˜ì •)
        async function addQuestion(e) {
             e.preventDefault();

             const editingId = document.getElementById('editingQuestionId').value;
             const passageIdVal = document.getElementById('questionPassage').value;

             const questionData = {
                 passageId: passageIdVal === 'none' ? null : parseInt(passageIdVal),
                 type: document.getElementById('questionType').value,
                 text: document.getElementById('questionText').value,
                 answer: document.getElementById('answer').value,
                 explanation: document.getElementById('explanation').value,
                 options: [] 
             };

             if (questionData.type === 'ê°ê´€ì‹') {
                 questionData.options = [
                     document.getElementById('option1').value,
                     document.getElementById('option2').value,
                     document.getElementById('option3').value,
                     document.getElementById('option4').value,
                     document.getElementById('option5').value
                 ].filter(opt => opt); 
             }

             try {
                 if (editingId) {
                     questionData.id = parseInt(editingId); 
                     await callWebApp('saveQuestion', questionData, 'POST');

                     const qIndex = sheetDB.questions.findIndex(q => q.id == editingId);
                     if (qIndex > -1) {
                         sheetDB.questions[qIndex] = questionData;
                     }
                     alert('ë¬¸ì œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');

                 } else {
                     questionData.id = Date.now(); 
                     await callWebApp('addQuestion', questionData, 'POST');

                     sheetDB.questions.push(questionData);
                     alert('ë¬¸ì œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                 }

                 resetQuestionForm();
                 loadQuestionList(); 
                 updateTeacherDashboard(); 

             } catch (error) {
                 alert(`ë¬¸ì œ ${editingId ? 'ìˆ˜ì •' : 'ë“±ë¡'} ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ` + error.message);
             }
         }


        // ë¬¸ì œ ëª©ë¡ ë¡œë“œ
        function loadQuestionList() {
            const tbody = document.getElementById('questionList');
            const html = sheetDB.questions.map(q => {
                const passage = sheetDB.passages.find(p => p.id == q.passageId); 
                
                return `
                    <tr>
                        <td>${passage ? passage.title : 'ë¬¸ë²•/ê°œë…'}</td>
                        <td>${q.text.substring(0, 30)}...</td>
                        <td>${q.type}</td>
                        <td>${q.answer}</td>
                        <td>
                            <button class="btn btn-warning" onclick="editQuestion(${q.id})" style="font-size: 0.9em; padding: 5px 10px;">ìˆ˜ì •</button>
                            <button class="btn btn-danger" onclick="deleteQuestion(${q.id})" style="font-size: 0.9em; padding: 5px 10px;">ì‚­ì œ</button>
                        </td>
                    </tr>
                `;
            }).join('');
            tbody.innerHTML = html || '<tr><td colspan="5">ë“±ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        }

        // ë¬¸ì œ ìˆ˜ì • í¼ ì±„ìš°ê¸°
        function editQuestion(id) {
            const q = sheetDB.questions.find(q => q.id == id);
            if (!q) return;

            document.getElementById('editingQuestionId').value = q.id;
            document.getElementById('questionPassage').value = q.passageId === null || q.passageId === '' ? 'none' : q.passageId; 
            document.getElementById('questionPassage').disabled = true;
            document.getElementById('questionType').value = q.type;
            document.getElementById('questionText').value = q.text;
            document.getElementById('answer').value = q.answer;
            document.getElementById('explanation').value = q.explanation || '';

            toggleQuestionOptions(); 

            let options = [];
             if(typeof q.options === 'string') {
                try { options = JSON.parse(q.options); } catch(e) {}
             } else if (Array.isArray(q.options)) {
                options = q.options;
             }

            if (q.type === 'ê°ê´€ì‹') {
                 document.getElementById('option1').value = options[0] || '';
                 document.getElementById('option2').value = options[1] || '';
                 document.getElementById('option3').value = options[2] || '';
                 document.getElementById('option4').value = options[3] || '';
                 document.getElementById('option5').value = options[4] || '';
             } else {
                 document.getElementById('option1').value = '';
                 document.getElementById('option2').value = '';
                 document.getElementById('option3').value = '';
                 document.getElementById('option4').value = '';
                 document.getElementById('option5').value = '';
             }


            document.querySelector('#questionForm button[type="submit"]').textContent = 'ìˆ˜ì • ì™„ë£Œ';
            window.scrollTo(0, 0);
        }

        // ë¬¸ì œ ì‚­ì œ
        async function deleteQuestion(id) {
            if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                 try {
                     await callWebApp('deleteQuestion', { id: id }, 'POST');
                     
                     sheetDB.questions = sheetDB.questions.filter(q => q.id != id);

                     loadQuestionList(); 
                     updateTeacherDashboard(); 

                     console.log(`ë¬¸ì œ(${id})ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                 } catch (error) {
                     alert("ë¬¸ì œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message);
                 }
            }
        }


        // ì„±ì  ì¡°íšŒ
        function loadResults() {
            const tbody = document.getElementById('resultsList');
            const html = sheetDB.results.map(r => {
                 const student = sheetDB.students.find(s => s.studentId == r.studentId);
                 const passage = sheetDB.passages.find(p => p.id == r.passageId);
                return `
                    <tr>
                        <td>${r.studentId}</td>
                        <td>${student ? student.name : '-'}</td>
                        <td>${passage ? passage.title : 'ë¬¸ë²•/ê°œë…'}</td>
                        <td>${r.readingTime || '-'}</td>
                         <td>${r.score !== null && r.score !== '' ? Number(r.score) + '%' : 'N/A'}</td>
                        <td>${r.submittedAt}</td>
                        <td>
                            <button class="btn btn-info" onclick="viewDetail('${r.id}')" style="font-size: 0.9em; padding: 5px 10px;">ìƒì„¸</button>
                        </td>
                    </tr>
                `;
            }).join('');
            tbody.innerHTML = html || '<tr><td colspan="7">ì œì¶œëœ ì„±ì ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        }

        // ì„±ì  ìƒì„¸ ë³´ê¸°
        function viewDetail(id) {
             const result = sheetDB.results.find(r => r.id == id);
             if (!result) return;

             const student = sheetDB.students.find(s => s.studentId == result.studentId);
             const passage = sheetDB.passages.find(p => p.id == result.passageId);

            document.getElementById('modalTitle').textContent = `${student?.name || 'ì•Œìˆ˜ì—†ìŒ'} í•™ìƒ ì„±ì  ìƒì„¸`;

             let answers = [];
             if(typeof result.answers === 'string') {
                 try { answers = JSON.parse(result.answers); } catch(e) {}
             } else if (Array.isArray(result.answers)) {
                 answers = result.answers;
             }


             const answersHtml = answers.map(a => {
                 const q = sheetDB.questions.find(q => q.id == a.questionId);
                 const isCorrect = String(a.correct).toUpperCase() === 'TRUE';
                 return `
                     <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                         <strong>ë¬¸ì œ:</strong> ${q ? q.text : 'ì‚­ì œëœ ë¬¸ì œ'}<br>
                         <strong>í•™ìƒ ë‹µ:</strong> ${a.userAnswer}<br>
                         <strong>ì •ë‹µ:</strong> ${q ? q.answer : '-'}<br>
                         <strong>ê²°ê³¼:</strong> ${isCorrect ? 'ì •ë‹µ' : 'ì˜¤ë‹µ'}
                     </div>
                 `;
             }).join('');


            document.getElementById('modalBody').innerHTML = `
                 <p><strong>ì§€ë¬¸:</strong> ${passage ? passage.title : 'ë¬¸ë²•/ê°œë…'}</p>
                 <p><strong>ë…í•´ ì‹œê°„:</strong> ${result.readingTime || '-'}</p>
                 <p><strong>ì ìˆ˜:</strong> ${Number(result.score)}%</p>
                 <h4 style="margin-top: 20px;">ë‹µì•ˆ ìƒì„¸</h4>
                 ${answersHtml || '<p>ë‹µì•ˆ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'}
            `;
            document.getElementById('editModal').classList.add('active');
        }

        // í†µê³„ ë¡œë“œ (ë¯¸êµ¬í˜„)
        function loadStatistics() { }

        // í•™ìƒ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
        function updateStudentDashboard() {
             const myResults = sheetDB.results.filter(r => r.studentId == currentUser.studentId);
             const myScoredResults = myResults.filter(r => r.score !== null && r.score !== ''); 

             document.getElementById('myTotalStudy').textContent = myResults.length;

             if (myScoredResults.length > 0) {
                 const avgScore = myScoredResults.reduce((sum, r) => sum + Number(r.score), 0) / myScoredResults.length;
                 document.getElementById('myAvgScore').textContent = Math.round(avgScore) + '%';
             } else {
                 document.getElementById('myAvgScore').textContent = '0%';
             }

            const times = myResults.filter(r => r.readingTime).map(r => {
                const parts = String(r.readingTime).split(':'); 
                if (parts.length === 2) {
                     const [min, sec] = parts.map(Number);
                     return min * 60 + sec;
                }
                return 0; 
            });
            if (times.length > 0) {
                const totalTime = times.reduce((sum, t) => sum + t, 0);
                if (totalTime > 0) {
                    const avgTime = totalTime / times.length;
                    const minutes = Math.floor(avgTime / 60);
                    const seconds = Math.floor(avgTime % 60);
                    document.getElementById('myAvgTime').textContent = `${minutes}ë¶„ ${seconds}ì´ˆ`;
                } else {
                     document.getElementById('myAvgTime').textContent = `0ë¶„ 0ì´ˆ`;
                }
            } else {
                document.getElementById('myAvgTime').textContent = `0ë¶„ 0ì´ˆ`;
            }
        }


        // ë…í•´ ì‹œì‘
        function startReading() {
            const passages = sheetDB.passages.filter(p => p.category === 'ë¹„ë¬¸í•™');
            if (passages.length === 0) {
                alert('ì•„ì§ ë“±ë¡ëœ ë¹„ë¬¸í•™ ì§€ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            currentPassage = passages[Math.floor(Math.random() * passages.length)];
             let blocks = [];
             if (typeof currentPassage.contentBlocks === 'string') {
                 try { blocks = JSON.parse(currentPassage.contentBlocks); } catch (e) { blocks = []; }
             } else {
                 blocks = currentPassage.contentBlocks || [];
             }
             currentPassage.contentBlocks = blocks;


            document.getElementById('readingArea').style.display = 'block';

            const fullPassageHtml = blocks.map(b => `<p>${b.para}</p>`).join('');
            document.getElementById('readingPassage').innerHTML = `
                <h4>${currentPassage.title}</h4>
                ${fullPassageHtml}
            `;

            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
        }

        // íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸
        function updateTimer() {
             const elapsed = Math.floor((Date.now() - startTime) / 1000);
             const minutes = Math.floor(elapsed / 60);
             const seconds = elapsed % 60;
             document.getElementById('timer').textContent =
                 `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // ë…í•´ ì™„ë£Œ
        function finishReading() {
             clearInterval(timerInterval);
             const readingTime = document.getElementById('timer').textContent;
             sessionStorage.setItem('readingTime', readingTime);

             document.getElementById('readingArea').style.display = 'none';

             const paragraphQuestions = (currentPassage.contentBlocks || []).filter(b => b.q && b.q.trim() !== '');

             if (paragraphQuestions.length > 0) {
                 document.getElementById('paragraphQuizArea').style.display = 'block';

                 const keywordHtml = paragraphQuestions.map((b, idx) => `
                     <div class="form-group">
                         <label>${b.q}</label>
                         <input type="text" id="keyword_answer_${idx}" class="form-group" style="width: 100%;">
                     </div>
                 `).join('');

                 document.getElementById('paragraphQuizContainer').innerHTML = keywordHtml;

             } else {
                 showMainQuiz();
             }
        }


        // ë¬¸ë‹¨ë³„ í€´ì¦ˆ ì œì¶œ
        function submitParagraphQuiz() {
             document.getElementById('paragraphQuizArea').style.display = 'none';
             showMainQuiz();
        }

        // ë©”ì¸ í€´ì¦ˆ í‘œì‹œ í•¨ìˆ˜
        async function showMainQuiz() {
            const questions = sheetDB.questions.filter(q => q.passageId == currentPassage.id);

            if (questions.length === 0) {
                alert('ì´ ì§€ë¬¸ì— ëŒ€í•œ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. í•™ìŠµì„ ì¢…ë£Œí•©ë‹ˆë‹¤.');
                resetStudy();
                const result = {
                    id: Date.now(),
                    studentId: currentUser.studentId,
                    passageId: currentPassage.id,
                    readingTime: sessionStorage.getItem('readingTime') || null,
                    score: null,
                    answers: [],
                    submittedAt: new Date().toLocaleString()
                };
                 try {
                     await callWebApp('addResult', result, 'POST');
                     sheetDB.results.push(result); 
                     sessionStorage.removeItem('readingTime');
                 } catch (error) {
                     alert("ê²°ê³¼ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message);
                 }
                return;
            }

            currentQuestions = questions;

            document.getElementById('quizArea').style.display = 'block';

            const quizHtml = questions.map((q, idx) => {
                 let options = [];
                 if(typeof q.options === 'string') {
                    try { options = JSON.parse(q.options); } catch(e) {}
                 } else if (Array.isArray(q.options)) {
                    options = q.options;
                 }
                 return `
                    <div class="question-card">
                        <span class="question-number">${idx + 1}</span>
                        <span>${q.text}</span>
                        ${q.type === 'ê°ê´€ì‹' ? `
                            <div class="options">
                                ${options.map((opt, i) => `
                                    <label class="option">
                                        <input type="radio" name="q${idx}" value="${i + 1}">
                                        ${i + 1}. ${opt}
                                    </label>
                                `).join('')}
                            </div>
                        ` : `
                            <input type="text" id="answer${idx}" class="form-control" style="margin-top: 10px;">
                        `}
                    </div>
                `}).join('');

            document.getElementById('quizContainer').innerHTML = quizHtml;
        }


        // ë¬¸ì œ í’€ê¸° ì‹œì‘ (ë¬¸ë²•/ê°œë…)
        function startQuiz() {
            const standaloneQuestions = sheetDB.questions.filter(q => q.passageId === null || q.passageId === ''); 

            if (standaloneQuestions.length === 0) {
                alert('ì•„ì§ ë“±ë¡ëœ ë¬¸ë²•/ê°œë… ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const questionCount = Math.min(5, standaloneQuestions.length);
            currentQuestions = standaloneQuestions.sort(() => 0.5 - Math.random()).slice(0, questionCount);
            currentPassage = null; 

            document.getElementById('quizArea').style.display = 'block';

             const quizHtml = currentQuestions.map((q, idx) => {
                 let options = [];
                 if(typeof q.options === 'string') {
                    try { options = JSON.parse(q.options); } catch(e) {}
                 } else if (Array.isArray(q.options)) {
                    options = q.options;
                 }

                return `
                    <div class="question-card">
                        <span class="question-number">${idx + 1}</span>
                        <span>${q.text}</span>
                        ${q.type === 'ê°ê´€ì‹' ? `
                            <div class="options">
                                ${options.map((opt, i) => `
                                    <label class="option">
                                        <input type="radio" name="q${idx}" value="${i + 1}">
                                        ${i + 1}. ${opt}
                                    </label>
                                `).join('')}
                            </div>
                        ` : `
                            <input type="text" id="answer${idx}" class="form-control" style="margin-top: 10px;">
                        `}
                    </div>
            `}).join('');

            document.getElementById('quizContainer').innerHTML = quizHtml;
        }

        // í€´ì¦ˆ ì œì¶œ
        async function submitQuiz() {
             let correctCount = 0;
             const answers = []; 

             currentQuestions.forEach((q, idx) => {
                 let userAnswer = '';
                 const correctAnswer = String(q.answer); 

                 if (q.type === 'ê°ê´€ì‹') {
                     const selected = document.querySelector(`input[name="q${idx}"]:checked`);
                     userAnswer = selected ? selected.value : '';
                 } else {
                     userAnswer = document.getElementById(`answer${idx}`).value;
                 }

                 const isCorrect = userAnswer === correctAnswer;
                 answers.push({
                     questionId: q.id,
                     userAnswer,
                     correct: isCorrect 
                 });

                 if (isCorrect) {
                     correctCount++;
                 }
             });

            const score = currentQuestions.length > 0 ? Math.round((correctCount / currentQuestions.length) * 100) : 0;

            const result = {
                id: Date.now(),
                studentId: currentUser.studentId,
                passageId: currentPassage ? currentPassage.id : null,
                readingTime: sessionStorage.getItem('readingTime') || null,
                score,
                 answers: answers, 
                submittedAt: new Date().toLocaleString()
            };

             try {
                 await callWebApp('addResult', result, 'POST');
                 
                  sheetDB.results.push(result);

                 document.getElementById('quizArea').style.display = 'none';
                 document.getElementById('resultArea').style.display = 'block';
                 document.getElementById('score').textContent = score + 'ì ';

                 let message = '';
                 if (score >= 90) message = 'ğŸ‰ í›Œë¥­í•©ë‹ˆë‹¤! ì™„ë²½í•œ ì´í•´ë ¥ì„ ë³´ì—¬ì£¼ì—ˆë„¤ìš”!';
                 else if (score >= 80) message = 'ğŸ‘ ì˜í–ˆìŠµë‹ˆë‹¤! ì¢‹ì€ ì´í•´ë ¥ì„ ê°€ì§€ê³  ìˆë„¤ìš”!';
                 else if (score >= 70) message = 'ğŸ˜Š ê´œì°®ìŠµë‹ˆë‹¤! ì¡°ê¸ˆë§Œ ë” ë…¸ë ¥í•˜ë©´ ë©ë‹ˆë‹¤!';
                 else if (score >= 60) message = 'ğŸ’ª í˜ë‚´ì„¸ìš”! ê¾¸ì¤€íˆ ì—°ìŠµí•˜ë©´ ì‹¤ë ¥ì´ ëŠ˜ì–´ìš”!';
                 else message = 'ğŸ“š ë” ì—°ìŠµì´ í•„ìš”í•´ìš”. ë‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”!';
                 document.getElementById('resultMessage').textContent = message;

                 sessionStorage.removeItem('readingTime');

             } catch (error) {
                 alert("ê²°ê³¼ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message);
             }
        }


        // í•™ìŠµ ì´ˆê¸°í™”
        function resetStudy() {
             document.getElementById('resultArea').style.display = 'none';
             document.getElementById('readingArea').style.display = 'none';
             document.getElementById('quizArea').style.display = 'none';
             document.getElementById('paragraphQuizArea').style.display = 'none';
             currentPassage = null;
             currentQuestions = [];
        }

        // ë‚´ ì„±ì  ë¡œë“œ
        function loadMyResults() {
             const myResults = sheetDB.results.filter(r => r.studentId == currentUser.studentId);

             const tbody = document.getElementById('myStudyHistory');
             const html = myResults.map(r => {
                 const passage = sheetDB.passages.find(p => p.id == r.passageId);
                 const scoreDisplay = (r.score !== null && r.score !== '') ? Number(r.score) + '%' : 'N/A';
                 let statusHtml = '';
                 if (r.score === null || r.score === '') {
                     statusHtml = '<span style="color: gray;">ë…í•´</span>';
                 } else {
                     statusHtml = Number(r.score) >= 80 ?
                         '<span style="color: green;">ìš°ìˆ˜</span>' :
                         '<span style="color: orange;">ë…¸ë ¥í•„ìš”</span>';
                 }

                 return `
                     <tr>
                         <td>${r.submittedAt}</td>
                         <td>${passage ? passage.title : 'ë¬¸ë²•/ê°œë…'}</td>
                         <td>${r.readingTime || '-'}</td>
                         <td>${scoreDisplay}</td>
                         <td>${statusHtml}</td>
                     </tr>
                 `;
             }).join('');
             tbody.innerHTML = html || '<tr><td colspan="5">í•™ìŠµ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';

             updateStudentDashboard();
         }


        // ìˆœìœ„ ë¡œë“œ
        function loadRanking() {
             const studentScores = {};

             sheetDB.students.forEach(s => {
                 const results = sheetDB.results.filter(r => r.studentId == s.studentId && r.score !== null && r.score !== '');
                 if (results.length > 0) {
                     const avgScore = results.reduce((sum, r) => sum + Number(r.score), 0) / results.length;
                     studentScores[s.studentId] = {
                         ...s,
                         avgScore: Math.round(avgScore),
                         studyCount: results.length
                     };
                 }
             });

             const ranking = Object.values(studentScores).sort((a, b) => b.avgScore - a.avgScore);

             const myRankIndex = ranking.findIndex(s => s.studentId == currentUser.studentId);
             const myRank = myRankIndex > -1 ? myRankIndex + 1 : '-';
             document.getElementById('myRank').textContent = myRank > 0 ? myRank + 'ìœ„' : '-';


             const tbody = document.getElementById('rankingList');
             const html = ranking.map((s, idx) => `
                 <tr ${s.studentId == currentUser.studentId ? 'style="background: #e8eaf6;"' : ''}>
                     <td>${idx + 1}ìœ„</td>
                     <td>${s.studentId}</td>
                     <td>${s.name}</td>
                     <td>${s.avgScore}%</td>
                     <td>${s.studyCount}íšŒ</td>
                 </tr>
             `).join('');
             tbody.innerHTML = html || '<tr><td colspan="5">ìˆœìœ„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
         }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('userType').addEventListener('change', toggleStudentFields);
            document.getElementById('questionType').addEventListener('change', toggleQuestionOptions);

            toggleStudentFields(); 

            await loadInitialData(); 

            document.getElementById('loginPage').style.display = 'flex';
            loadingOverlay.classList.remove('active'); 
        });
       
    </script>
</body>
</html>