<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>국어 학습 통합 시스템 (v3 - Google Sheet Linked)</title>
    <link rel="manifest" href="manifest.json"> 
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 1400px;
            min-height: 80vh;
            overflow: hidden;
            position: relative; 
        }
        /* --- Loading Overlay --- */
        #loadingOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            color: #333;
            z-index: 2000; 
            display: none; 
        }
        #loadingOverlay.active {
            display: flex;
        }
        /* --- End Loading Overlay --- */

        /* 로그인 페이지 스타일 */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            padding: 40px;
        }

        .login-box {
            width: 100%;
            max-width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #666;
            font-size: 1.1em;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-group label {
            color: #555;
            font-weight: 600;
            font-size: 0.95em;
        }

        .input-group input, .input-group select {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-btn {
            padding: 14px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .error-message {
            color: #e74c3c;
            text-align: center;
            padding: 10px;
            background: #ffe4e4;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        /* 메인 헤더 스타일 */
        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: white;
            font-size: 1.8em;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
            color: white;
        }

        .user-info span {
            font-size: 1.1em;
        }

        .logout-btn {
            padding: 8px 20px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* 탭 메뉴 스타일 */
        .tab-menu {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
        }

        .tab-btn {
            padding: 15px 25px;
            background: none;
            border: none;
            color: #666;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            position: relative;
        }

        .tab-btn:hover {
            background: #f0f0f0;
        }

        .tab-btn.active {
            color: #667eea;
            background: white;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #667eea;
        }

        /* 콘텐츠 영역 */
        .content {
            padding: 30px;
            min-height: 500px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 카드 스타일 */
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }

        .card:hover {
            box-shadow: 0 5px 20px rgba(0,0,0,0.12);
        }

        .card-title {
            color: #333;
            font-size: 1.4em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        /* 버튼 스타일 */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f7971e, #ffd200);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #eb3349, #f45c43);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #2196F3, #00BCD4);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        /* 폼 스타일 */
        .form-group {
            margin-bottom: 20px;
        }

        .paragraph-block {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fdfdfd;
        }
        .paragraph-block label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }
        .paragraph-block textarea {
            min-height: 100px;
        }
        .paragraph-q-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .paragraph-q-group input {
            width: 50%;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* 테이블 스타일 */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        td button {
            margin-bottom: 5px;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* 통계 카드 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.12);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        /* 독해 타이머 */
        .timer-display {
            font-size: 3em;
            color: #667eea;
            text-align: center;
            margin: 30px 0;
            font-weight: bold;
        }

        .passage-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            margin: 20px 0;
            line-height: 1.8;
            font-size: 1.1em;
        }

        /* 문제 스타일 */
        .question-card {
            background: white;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .passage-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        .passage-card h4 {
            font-size: 1.2em;
            color: #333;
        }
        .passage-card p {
            color: #666;
            margin: 10px 0;
        }
        .passage-card-actions {
            margin-top: 15px;
        }


        .question-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            background: #667eea;
            color: white;
            text-align: center;
            line-height: 30px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .options {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option:hover {
            background: #e8eaf6;
        }

        .option input[type="radio"] {
            margin-right: 10px;
        }

        /* 결과 표시 */
        .result-container {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-top: 30px;
        }

        .result-score {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .result-message {
            font-size: 1.2em;
        }

        /* 차트 컨테이너 */
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .container {
                border-radius: 0;
                min-height: 100vh;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .tab-menu {
                flex-wrap: wrap;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .timer-display {
                font-size: 2em;
            }
        }

        /* 로딩 스피너 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 알림 메시지 */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* 모달 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        /* 모달 본문 줄바꿈 적용 */
        .modal-body {
            white-space: pre-wrap;
        }

        .modal-body form {
            white-space: normal;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5em;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <div id="loadingOverlay">
             <div class="loading"></div>&nbsp; 데이터를 로드/저장하는 중...
        </div>

        <div id="loginPage" class="login-container">
            <div class="login-box">
                <div class="login-header">
                    <h1>📚 국어 학습 시스템</h1>
                    <p>로그인하여 학습을 시작하세요</p>
                </div>
                <form class="login-form" onsubmit="handleLogin(event)">
                    <div class="input-group">
                        <label>사용자 유형</label>
                        <select id="userType">
                            <option value="student">학생</option>
                            <option value="teacher">교사</option>
                        </select>
                    </div>
                    <div class="input-group" id="studentIdGroup">
                        <label>학번 (예: 030201)</label>
                        <input type="text" id="studentId" placeholder="3학년 2반 1번 → 030201">
                    </div>
                    <div class="input-group">
                        <label>아이디</label>
                        <input type="text" id="userId" required>
                    </div>
                    <div class="input-group">
                        <label>비밀번호</label>
                        <input type="password" id="password" required>
                    </div>
                    <button type="submit" class="login-btn">로그인</button>
                    <div id="errorMessage" class="error-message"></div>
                </form>
            </div>
        </div>

        <div id="teacherPage" style="display: none;">
            <div class="header">
                <h1>📚 국어 학습 시스템 - 교사용</h1>
                <div class="user-info">
                    <span id="teacherName"></span>
                    <button class="logout-btn" onclick="logout()">로그아웃</button>
                </div>
            </div>

            <div class="tab-menu">
                <button class="tab-btn active" onclick="switchTab('dashboard', this)">대시보드</button>
                <button class="tab-btn" onclick="switchTab('students', this)">학생 관리</button>
                <button class="tab-btn" onclick="switchTab('passages', this)">지문 관리</button>
                <button class="tab-btn" onclick="switchTab('questions', this)">문제 관리</button>
                <button class="tab-btn" onclick="switchTab('results', this)">성적 조회</button>
                <button class="tab-btn" onclick="switchTab('statistics', this)">통계 분석</button>
            </div>

            <div class="content">
                <div id="dashboard" class="tab-content active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalStudents">0</div>
                            <div class="stat-label">전체 학생 수</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalPassages">0</div>
                            <div class="stat-label">등록된 지문</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalQuestions">0</div>
                            <div class="stat-label">등록된 문제</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avgScore">0%</div>
                            <div class="stat-label">평균 성적</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">최근 활동 (Google Sheet 연동 후 비활성화)</h3>
                        <div id="recentActivities">
                           <p style="color: grey;">(활동 로그는 Google Sheet 연동 시 별도로 기록되지 않습니다)</p>
                        </div>
                    </div>
                </div>

                <div id="students" class="tab-content">
                    <div class="card">
                        <h3 class="card-title">학생 등록</h3>
                        <form onsubmit="addStudent(event)">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div class="form-group">
                                    <label>학년</label>
                                    <select id="grade">
                                        <option value="1">1학년</option>
                                        <option value="2">2학년</option>
                                        <option value="3">3학년</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>반</label>
                                    <input type="number" id="class" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>번호</label>
                                    <input type="number" id="number" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>이름</label>
                                    <input type="text" id="studentName" required>
                                </div>
                                <div class="form-group">
                                    <label>아이디</label>
                                    <input type="text" id="studentUserId" required>
                                </div>
                                <div class="form-group">
                                    <label>비밀번호</label>
                                    <input type="text" id="studentPassword" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">학생 등록</button>
                        </form>
                    </div>

                    <div class="card">
                        <h3 class="card-title">학생 목록</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>학번</th>
                                        <th>이름</th>
                                        <th>아이디</th>
                                        <th>계정 상태</th>
                                        <th>작업</th>
                                    </tr>
                                </thead>
                                <tbody id="studentList">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="passages" class="tab-content">
                    <div class="card">
                        <h3 class="card-title">지문 등록</h3>
                        <form onsubmit="addPassage(event)">
                            <div class="form-group">
                                <label>지문 제목</label>
                                <input type="text" id="passageTitle" required>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label>카테고리</label>
                                    <select id="passageCategory">
                                        <option value="비문학">비문학</option>
                                        <option value="문학">문학</option>
                                        <option value="문법">문법</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>난이도</label>
                                    <select id="passageDifficulty">
                                        <option value="중학교">중학교</option>
                                        <option value="고1-2">고1-2</option>
                                        <option value="고3">고3</option>
                                    </select>
                                </div>
                            </div>

                            <hr style="margin: 20px 0;">
                            <label style="font-weight: 600; font-size: 1.1em; margin-bottom: 15px; display:block;">문단별 내용 및 질문 등록</label>

                            <div id="passageParagraphsContainer">
                                <div class="paragraph-block">
                                    <label>1문단</label>
                                    <textarea class="para-content" placeholder="1문단 내용을 입력하세요." required></textarea>
                                    <div class="paragraph-q-group">
                                        <input type="text" class="para-question" placeholder="이 문단의 질문 (예: 1문단의 핵심어는?)">
                                        <input type="text" class="para-answer" placeholder="질문의 정답 (학생에겐 보이지 않음)">
                                    </div>
                                </div>
                            </div>

                            <button type="button" class="btn btn-secondary" onclick="addParagraphField()">문단 추가</button>
                            <button type="submit" class="btn btn-primary">지문 등록</button>
                        </form>
                    </div>

                    <div class="card">
                        <h3 class="card-title">지문 목록</h3>
                        <div id="passageList">
                            </div>
                    </div>
                </div>

                <div id="questions" class="tab-content">
                    <div class="card">
                        <h3 class="card-title">문제 등록</h3>
                        <form id="questionForm" onsubmit="addQuestion(event)">
                            <input type="hidden" id="editingQuestionId">

                            <div class="form-group">
                                <label>지문 선택</label>
                                <select id="questionPassage" required>
                                    <option value="none" selected>없음 (문법/개념 문제)</option>
                                    </select>
                            </div>
                            <div class="form-group">
                                <label>문제 유형</label>
                                <select id="questionType">
                                    <option value="객관식">객관식</option>
                                    <option value="단답형">단답형</option>
                                    <option value="서술형">서술형</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>문제</label>
                                <textarea id="questionText" required></textarea>
                            </div>
                            <div id="optionsContainer" class="form-group">
                                <label>선택지 (객관식)</label>
                                <input type="text" id="option1" placeholder="① 번">
                                <input type="text" id="option2" placeholder="② 번">
                                <input type="text" id="option3" placeholder="③ 번">
                                <input type="text" id="option4" placeholder="④ 번">
                                <input type="text" id="option5" placeholder="⑤ 번">
                            </div>
                            <div class="form-group">
                                <label>정답 (객관식은 번호, 단답형/서술형은 답안)</label>
                                <input type="text" id="answer" required>
                            </div>
                            <div class="form-group">
                                <label>해설</label>
                                <textarea id="explanation"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">문제 저장</button>
                            <button type="button" class="btn btn-secondary" onclick="resetQuestionForm()">취소</button>
                        </form>
                    </div>

                    <div class="card">
                        <h3 class="card-title">문제 목록</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>지문</th>
                                        <th>문제</th>
                                        <th>유형</th>
                                        <th>정답</th>
                                        <th>작업</th>
                                    </tr>
                                </thead>
                                <tbody id="questionList">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="results" class="tab-content">
                    <div class="card">
                        <h3 class="card-title">성적 조회</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>학번</th>
                                        <th>이름</th>
                                        <th>지문</th>
                                        <th>독해 시간</th>
                                        <th>정답률</th>
                                        <th>제출 시각</th>
                                        <th>상세보기</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsList">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="statistics" class="tab-content">
                    <div class="card">
                        <h3 class="card-title">학급별 성적 분포</h3>
                        <canvas id="classChart"></canvas>
                    </div>
                    <div class="card">
                        <h3 class="card-title">분야별 평균 성적</h3>
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="studentPage" style="display: none;">
            <div class="header">
                <h1>📚 국어 학습 시스템 - 학생용</h1>
                <div class="user-info">
                    <span id="studentInfo"></span>
                    <button class="logout-btn" onclick="logout()">로그아웃</button>
                </div>
            </div>

            <div class="tab-menu">
                <button class="tab-btn active" onclick="switchStudentTab('study', this)">학습하기</button>
                <button class="tab-btn" onclick="switchStudentTab('myResults', this)">내 성적</button>
                <button class="tab-btn" onclick="switchStudentTab('ranking', this)">순위</button>
            </div>

            <div class="content">
                <div id="study" class="tab-content active">
                    <div class="card">
                        <h3 class="card-title">학습 선택</h3>
                        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="startReading()">독해 연습</button>
                            <button class="btn btn-success" onclick="startQuiz()">문법/개념 풀기</button>
                        </div>
                    </div>

                    <div id="readingArea" class="card" style="display: none;">
                        <h3 class="card-title">독해 연습</h3>
                        <div class="timer-display" id="timer">00:00</div>
                        <div class="passage-container" id="readingPassage">
                            </div>
                        <button class="btn btn-primary" onclick="finishReading()">독해 완료</button>
                    </div>

                    <div id="paragraphQuizArea" class="card" style="display: none;">
                        <h3 class="card-title">문단별 내용 확인</h3>
                        <p>지문의 각 문단별 질문에 답하세요.</p>
                        <br>
                        <div id="paragraphQuizContainer">
                            </div>
                        <button class="btn btn-primary" onclick="submitParagraphQuiz()" style="margin-top: 20px;">
                            제출 후 문제 풀기
                        </button>
                    </div>

                    <div id="quizArea" class="card" style="display: none;">
                        <h3 class="card-title">문제 풀기</h3>
                        <div id="quizContainer">
                            </div>
                        <button class="btn btn-success" onclick="submitQuiz()">제출하기</button>
                    </div>

                    <div id="resultArea" class="result-container" style="display: none;">
                        <div class="result-score" id="score"></div>
                        <div class="result-message" id="resultMessage"></div>
                        <button class="btn btn-primary" onclick="resetStudy()" style="margin-top: 20px;">다시 학습하기</button>
                    </div>
                </div>

                <div id="myResults" class="tab-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="myAvgScore">0%</div>
                            <div class="stat-label">평균 성적</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="myTotalStudy">0</div>
                            <div class="stat-label">학습 횟수</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="myAvgTime">0분</div>
                            <div class="stat-label">평균 독해 시간</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="myRank">-</div>
                            <div class="stat-label">전체 순위</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">학습 이력</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>날짜</th>
                                        <th>지문</th>
                                        <th>독해 시간</th>
                                        <th>점수</th>
                                        <th>상태</th>
                                    </tr>
                                </thead>
                                <tbody id="myStudyHistory">
                                    </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">성장 그래프</h3>
                        <canvas id="growthChart"></canvas>
                    </div>
                </div>

                <div id="ranking" class="tab-content">
                    <div class="card">
                        <h3 class="card-title">🏆 전체 순위</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>순위</th>
                                        <th>학번</th>
                                        <th>이름</th>
                                        <th>평균 점수</th>
                                        <th>학습 횟수</th>
                                    </tr>
                                </thead>
                                <tbody id="rankingList">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal" id="editModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="modalTitle"></h3>
                    <button class="close-btn" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body" id="modalBody">
                    </div>
            </div>
        </div>
    </div>

    <script>
        // --- Google Sheet Integration ---
        // 🚨 중요: 여기에 선생님의 웹 앱 URL을 붙여넣으세요.
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw_RB6q2ergpy4FzDeyqJ6_nSmJRBSQ5AD6_o2qiL5QjI72ZBLetsqEx0JH9F4WwTozjQ/exec"; 
        const loadingOverlay = document.getElementById('loadingOverlay');

        async function callWebApp(action, payload = {}, method = 'GET') {
            loadingOverlay.classList.add('active'); 
            try {
                let url = WEB_APP_URL + '?action=' + action;
                let options = { method: 'GET', redirect: 'follow' };

                if (method === 'POST') {
                    // GAS POST request workaround: use GET with payload in URL
                    url = WEB_APP_URL + '?action=' + action + '&payload=' + encodeURIComponent(JSON.stringify(payload));
                    options = { method: 'GET', redirect: 'follow' }; 
                } else { 
                    if (Object.keys(payload).length > 0) {
                         url += '&payload=' + encodeURIComponent(JSON.stringify(payload));
                    }
                    options = { method: 'GET', redirect: 'follow' };
                }

                const response = await fetch(url, options);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();

                if (result.status === 'error') {
                    throw new Error(result.message);
                }
                
                loadingOverlay.classList.remove('active'); 
                return result;

            } catch (error) {
                console.error("Error calling Web App:", error);
                alert("오류가 발생했습니다: Failed to fetch / " + error.message);
                loadingOverlay.classList.remove('active'); 
                throw error;
            }
        }
        // --- End Google Sheet Integration ---


        // 데이터 저장소 (Google Sheet 데이터를 임시 저장하는 역할)
        let sheetDB = {
             teachers: [ { id: 'teacher1', password: 'pass123', name: '김선생' } ], 
            students: [],
            passages: [],
            questions: [],
            results: []
        };

        // 현재 로그인 사용자
        let currentUser = null;

        // 독해 타이머 변수
        let timerInterval = null;
        let startTime = null;
        let currentPassage = null;
        let currentQuestions = [];

        // 초기 데이터 로드 함수
        async function loadInitialData() {
            try {
                const result = await callWebApp('loadDB');
                if (result.data) {
                    sheetDB.students = result.data.students || [];
                    sheetDB.passages = result.data.passages || [];
                    sheetDB.questions = result.data.questions || [];
                    sheetDB.results = result.data.results || [];
                } else {
                     sheetDB.students = [];
                     sheetDB.passages = [];
                     sheetDB.questions = [];
                     sheetDB.results = [];
                }
            } catch (error) {
                console.error("Failed to load initial data:", error);
                // alert("데이터를 불러오는 데 실패했습니다. 인터넷 연결을 확인하거나 관리자에게 문의하세요.");
            }
        }


        // 로그인 처리
        function handleLogin(e) {
            e.preventDefault();

            const userType = document.getElementById('userType').value;
            const userId = document.getElementById('userId').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('errorMessage');
            errorMsg.style.display = 'none';

            if (userType === 'teacher') {
                const teacher = sheetDB.teachers.find(t => t.id === userId && t.password === password);
                if (teacher) {
                    currentUser = { type: 'teacher', ...teacher };
                    showTeacherPage();
                } else {
                    errorMsg.textContent = '아이디 또는 비밀번호가 일치하지 않습니다.';
                    errorMsg.style.display = 'block';
                }
            } else {
                const studentId = document.getElementById('studentId').value;
                const student = sheetDB.students.find(s =>
                    s.studentId == studentId && s.userId == userId && s.password == password
                );
                if (student) {
                    if (String(student.isActive).toUpperCase() !== 'TRUE') {
                         errorMsg.textContent = '비활성화된 계정입니다. 선생님께 문의하세요.';
                         errorMsg.style.display = 'block';
                         return;
                     }
                    currentUser = { type: 'student', ...student };
                    showStudentPage();
                } else {
                    errorMsg.textContent = '학번, 아이디 또는 비밀번호가 일치하지 않습니다.';
                    errorMsg.style.display = 'block';
                }
            }
        }

        // 학생 필드 토글
        function toggleStudentFields() {
            const userType = document.getElementById('userType').value;
            const studentIdGroup = document.getElementById('studentIdGroup');
            // display: flex 대신 block으로 설정하여 레이아웃 문제 해결
            studentIdGroup.style.display = userType === 'student' ? 'flex' : 'none';
            if (userType === 'student') {
                document.getElementById('studentId').required = true;
            } else {
                document.getElementById('studentId').required = false;
            }
        }

        // 교사 페이지 표시 
        function showTeacherPage() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('teacherPage').style.display = 'block';
            document.getElementById('teacherName').textContent = currentUser.name + ' 선생님';
            updateTeacherDashboard();
            loadStudentList();
            loadPassageList();
            loadQuestionPassages();
            loadQuestionList();
        }

        // 학생 페이지 표시 
        function showStudentPage() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('studentPage').style.display = 'block';
            document.getElementById('studentInfo').textContent =
                `${currentUser.grade}학년 ${currentUser.class}반 ${currentUser.number}번 ${currentUser.name}`;
            updateStudentDashboard();
            loadMyResults(); 
            loadRanking();   
        }

        // 로그아웃
        function logout() {
            currentUser = null;
            document.getElementById('teacherPage').style.display = 'none';
            document.getElementById('studentPage').style.display = 'none';
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('userId').value = '';
            document.getElementById('password').value = '';
            document.getElementById('studentId').value = '';
            document.getElementById('userType').value = 'student';
            toggleStudentFields();
        }

        // 교사용 탭 전환
        function switchTab(tabId, btn) {
            document.querySelectorAll('#teacherPage .tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('#teacherPage .tab-btn').forEach(b => {
                b.classList.remove('active');
            });

            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');

            if (tabId === 'dashboard') updateTeacherDashboard();
            if (tabId === 'students') loadStudentList();
            if (tabId === 'passages') loadPassageList();
            if (tabId === 'questions') {
                loadQuestionPassages(); 
                loadQuestionList();     
                resetQuestionForm();
            }
            if (tabId === 'results') loadResults(); 
            // if (tabId === 'statistics') loadStatistics(); 
        }

        // 학생용 탭 전환
        function switchStudentTab(tabId, btn) {
            document.querySelectorAll('#studentPage .tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('#studentPage .tab-btn').forEach(b => {
                b.classList.remove('active');
            });

            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');

            if (tabId === 'myResults') loadMyResults();
            if (tabId === 'ranking') loadRanking();
        }

        // 교사 대시보드 업데이트
        function updateTeacherDashboard() {
            document.getElementById('totalStudents').textContent = sheetDB.students.length;
            document.getElementById('totalPassages').textContent = sheetDB.passages.length;
            document.getElementById('totalQuestions').textContent = sheetDB.questions.length;

            const resultsWithScore = sheetDB.results.filter(r => r.score !== null && r.score !== ''); 
             if(resultsWithScore.length > 0) {
                 const totalScore = resultsWithScore.reduce((sum, r) => sum + Number(r.score), 0);
                 const avgScore = totalScore / resultsWithScore.length;
                 document.getElementById('avgScore').textContent = Math.round(avgScore) + '%';
             } else {
                 document.getElementById('avgScore').textContent = '0%';
             }

            document.getElementById('recentActivities').innerHTML = '<p style="color: grey;">(활동 로그는 Google Sheet 연동 시 별도로 기록되지 않습니다)</p>';
        }

        // 학생 추가
        async function addStudent(e) {
            e.preventDefault();

            const grade = document.getElementById('grade').value;
            const classNum = document.getElementById('class').value;
            const number = document.getElementById('number').value;
            const name = document.getElementById('studentName').value;
            const userId = document.getElementById('studentUserId').value;
            const password = document.getElementById('studentPassword').value;

            const studentId = '0' + grade + classNum.padStart(2, '0') + number.padStart(2, '0');

            if (sheetDB.students.some(s => s.studentId == studentId)) {
                alert('이미 등록된 학번입니다.');
                return;
            }
            if (sheetDB.students.some(s => s.userId == userId)) {
                alert('이미 사용중인 아이디입니다.');
                return;
            }

            const student = {
                studentId, userId, password, name,
                grade: parseInt(grade),
                class: parseInt(classNum),
                number: parseInt(number),
                isActive: true,
                registeredAt: new Date().toLocaleString()
            };

            try {
                const result = await callWebApp('addStudent', student, 'POST');
                sheetDB.students.push(student);
                alert(`학생이 등록되었습니다.\n학번: ${studentId}\n아이디: ${userId}\n비밀번호: ${password}`);
                e.target.reset();
                loadStudentList(); 
                updateTeacherDashboard(); 
            } catch (error) {
                alert("학생 등록 중 오류 발생: " + error.message);
            }
        }


        // 학생 목록 로드 
        function loadStudentList() {
            const tbody = document.getElementById('studentList');
            const html = sheetDB.students.sort((a,b) => String(a.studentId).localeCompare(String(b.studentId))).map(s => {
                const isActive = String(s.isActive).toUpperCase() === 'TRUE';
                return `
                    <tr>
                        <td>${s.studentId}</td>
                        <td>${s.name}</td>
                        <td>${s.userId}</td>
                        <td>
                            ${isActive ?
                                '<span style="color:green; font-weight:bold;">활성</span>' :
                                '<span style="color:gray;">비활성</span>'}
                        </td>
                        <td>
                            <button class="btn btn-warning" onclick="editStudent('${s.studentId}')" style="font-size: 0.9em; padding: 5px 10px;">수정</button>
                            <button class="btn ${isActive ? 'btn-secondary' : 'btn-success'}" onclick="toggleStudentStatus('${s.studentId}')" style="font-size: 0.9em; padding: 5px 10px;">
                                ${isActive ? '비활성' : '활성'}
                            </button>
                            <button class="btn btn-danger" onclick="deleteStudent('${s.studentId}')" style="font-size: 0.9em; padding: 5px 10px;">삭제</button>
                        </td>
                    </tr>
            `}).join('');
            tbody.innerHTML = html || '<tr><td colspan="5">등록된 학생이 없습니다.</td></tr>';
        }

        // 학생 수정 모달 열기 
        function editStudent(studentId) {
            const student = sheetDB.students.find(s => s.studentId == studentId);
            if (!student) return;

            document.getElementById('modalTitle').textContent = '학생 정보 수정';
            document.getElementById('modalBody').innerHTML = `
                <form id="editStudentForm" onsubmit="saveStudent(event, '${student.studentId}')">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>학번</label>
                            <input type="text" id="editStudentId" value="${student.studentId}" disabled>
                        </div>
                        <div class="form-group">
                            <label>학년</label>
                            <input type="number" id="editGrade" value="${student.grade}" required>
                        </div>
                        <div class="form-group">
                            <label>반</label>
                            <input type="number" id="editClass" value="${student.class}" required>
                        </div>
                        <div class="form-group">
                            <label>번호</label>
                            <input type="number" id="editNumber" value="${student.number}" required>
                        </div>
                        <div class="form-group">
                            <label>이름</label>
                            <input type="text" id="editStudentName" value="${student.name}" required>
                        </div>
                        <div class="form-group">
                            <label>아이디</label>
                            <input type="text" id="editStudentUserId" value="${student.userId}" required>
                        </div>
                        <div class="form-group">
                            <label>비밀번호</label>
                            <input type="text" id="editStudentPassword" value="${student.password}" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">저장</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">취소</button>
                </form>
            `;
            document.getElementById('editModal').classList.add('active');
        }

        // 학생 정보 저장
        async function saveStudent(e, originalStudentId) {
             e.preventDefault();
             const studentIndex = sheetDB.students.findIndex(s => s.studentId == originalStudentId);
             if (studentIndex === -1) {
                 alert("수정할 학생을 찾을 수 없습니다.");
                 return;
             }
             const originalStudent = sheetDB.students[studentIndex];


             const newGrade = document.getElementById('editGrade').value;
             const newClass = document.getElementById('editClass').value;
             const newNumber = document.getElementById('editNumber').value;
             const newStudentId = '0' + newGrade + newClass.padStart(2, '0') + newNumber.padStart(2, '0');
             const newUserId = document.getElementById('editStudentUserId').value;
             const newName = document.getElementById('editStudentName').value;
             const newPassword = document.getElementById('editStudentPassword').value;

             if (newStudentId != originalStudentId && sheetDB.students.some(s => s.studentId == newStudentId)) {
                 alert('이미 존재하는 학번입니다.');
                 return;
             }
             if (newUserId != originalStudent.userId && sheetDB.students.some(s => s.userId == newUserId)) {
                 alert('이미 존재하는 아이디입니다.');
                 return;
             }

            const updatedStudentData = {
                originalStudentId: originalStudentId, 
                studentId: newStudentId,
                userId: newUserId,
                password: newPassword,
                name: newName,
                grade: parseInt(newGrade),
                class: parseInt(newClass),
                number: parseInt(newNumber),
                isActive: originalStudent.isActive 
            };

            try {
                await callWebApp('saveStudent', updatedStudentData, 'POST');
                sheetDB.students[studentIndex] = { ...updatedStudentData, registeredAt: originalStudent.registeredAt }; 
                
                loadStudentList(); 
                closeModal();
                alert('학생 정보가 수정되었습니다.');
            } catch (error) {
                alert("학생 정보 저장 중 오류 발생: " + error.message);
            }
        }


        // 학생 계정 상태 토글
        async function toggleStudentStatus(studentId) {
            const studentIndex = sheetDB.students.findIndex(s => s.studentId == studentId);
            if (studentIndex === -1) return;

             const currentStatus = String(sheetDB.students[studentIndex].isActive).toUpperCase() === 'TRUE';
             const studentName = sheetDB.students[studentIndex].name; 

            try {
                const result = await callWebApp('toggleStudentStatus', { studentId: studentId }, 'POST');
                
                 sheetDB.students[studentIndex].isActive = !currentStatus;

                loadStudentList(); 
                
                const status = !currentStatus ? '활성화' : '비활성화';
                 console.log(`${studentName} 학생 계정이 ${status}되었습니다.`); 
            } catch (error) {
                alert("계정 상태 변경 중 오류 발생: " + error.message);
            }
        }


        // 학생 삭제
        async function deleteStudent(studentId) {
             const studentName = sheetDB.students.find(s => s.studentId == studentId)?.name || studentId;
             if (confirm(`'${studentName}' 학생을 정말 삭제하시겠습니까?\n(성적 기록도 함께 삭제됩니다)`)) {
                try {
                    await callWebApp('deleteStudent', { studentId: studentId }, 'POST');
                    
                     sheetDB.students = sheetDB.students.filter(s => s.studentId != studentId);
                     sheetDB.results = sheetDB.results.filter(r => r.studentId != studentId); 

                    loadStudentList(); 
                    updateTeacherDashboard(); 
                    loadResults(); 

                    console.log(`학생(${studentId})이 삭제되었습니다.`);
                } catch (error) {
                    alert("학생 삭제 중 오류 발생: " + error.message);
                }
            }
        }

        // 문단 입력 필드 추가
        function addParagraphField() {
            const container = document.getElementById('passageParagraphsContainer');
            const newIndex = container.children.length + 1;

            const div = document.createElement('div');
            div.className = 'paragraph-block';
            div.innerHTML = `
                <label>${newIndex}문단</label>
                <textarea class="para-content" placeholder="${newIndex}문단 내용을 입력하세요." required></textarea>
                <div class="paragraph-q-group">
                    <input type="text" class="para-question" placeholder="이 문단의 질문">
                    <input type="text" class="para-answer" placeholder="질문의 정답">
                </div>
            `;
            container.appendChild(div);
        }

        // 지문 추가
        async function addPassage(e) {
            e.preventDefault();

            const contentBlocks = [];
            const paraBlocks = document.querySelectorAll('#passageParagraphsContainer .paragraph-block');

            for(let block of paraBlocks) {
                const para = block.querySelector('.para-content').value;
                const q = block.querySelector('.para-question').value;
                const a = block.querySelector('.para-answer').value;

                if (para) {
                    contentBlocks.push({ para, q, a });
                }
            }

            if (contentBlocks.length === 0) {
                alert('하나 이상의 문단 내용을 입력해야 합니다.');
                return;
            }

            const passage = {
                id: Date.now(), 
                title: document.getElementById('passageTitle').value,
                category: document.getElementById('passageCategory').value,
                difficulty: document.getElementById('passageDifficulty').value,
                contentBlocks: contentBlocks,
                createdAt: new Date().toLocaleString()
            };

            try {
                await callWebApp('addPassage', passage, 'POST');
                
                sheetDB.passages.push(passage);

                alert('지문이 등록되었습니다.');
                e.target.reset();
                document.getElementById('passageParagraphsContainer').innerHTML = `
                    <div class="paragraph-block">
                        <label>1문단</label>
                        <textarea class="para-content" placeholder="1문단 내용을 입력하세요." required></textarea>
                        <div class="paragraph-q-group">
                            <input type="text" class="para-question" placeholder="이 문단의 질문 (예: 1문단의 핵심어는?)">
                            <input type="text" class="para-answer" placeholder="질문의 정답 (학생에겐 보이지 않음)">
                        </div>
                    </div>
                `;
                loadPassageList(); 
                updateTeacherDashboard(); 
                loadQuestionPassages(); 

            } catch (error) {
                alert("지문 등록 중 오류 발생: " + error.message);
            }
        }


        // 지문 목록 로드
        function loadPassageList() {
            const container = document.getElementById('passageList');
            const html = sheetDB.passages.map(p => {
                 let blocks = [];
                 if (typeof p.contentBlocks === 'string') {
                     try { blocks = JSON.parse(p.contentBlocks); } catch (e) { blocks = []; }
                 } else if (Array.isArray(p.contentBlocks)) {
                     blocks = p.contentBlocks;
                 }
                 const preview = blocks[0] ? blocks[0].para.substring(0, 100) : "내용 없음";

                return `
                <div class="passage-card">
                    <h4>${p.title}</h4>
                    <p>카테고리: ${p.category} | 난이도: ${p.difficulty} | 문단 수: ${blocks.length}</p>
                    <p style="color: #888;">${preview}...</p>
                    <div class="passage-card-actions">
                        <button class="btn btn-info" onclick="viewPassage(${p.id})">내용 보기</button>
                        <button class="btn btn-warning" onclick="editPassage(${p.id})">수정</button>
                        <button class="btn btn-danger" onclick="deletePassage(${p.id})">삭제</button>
                    </div>
                </div>
            `}).join('');
            container.innerHTML = html || '<p>등록된 지문이 없습니다.</p>';
        }

        // 지문 내용 보기 모달 함수
        function viewPassage(id) {
            const passage = sheetDB.passages.find(p => p.id == id);
            if (!passage) return;

             let blocks = [];
             if (typeof passage.contentBlocks === 'string') {
                 try { blocks = JSON.parse(passage.contentBlocks); } catch (e) { blocks = []; }
             } else {
                 blocks = passage.contentBlocks || [];
             }

            document.getElementById('modalTitle').textContent = passage.title;
            const fullContent = blocks.map(b => b.para).join('\n\n');
            document.getElementById('modalBody').textContent = fullContent;
            document.getElementById('editModal').classList.add('active');
        }

        // 지문 수정 모달 열기 
        function editPassage(id) {
            const passage = sheetDB.passages.find(p => p.id == id);
            if (!passage) return;

             let blocks = [];
             if (typeof passage.contentBlocks === 'string') {
                 try { blocks = JSON.parse(passage.contentBlocks); } catch (e) { blocks = []; }
             } else {
                 blocks = passage.contentBlocks || [];
             }


            document.getElementById('modalTitle').textContent = '지문 수정';

            const paragraphsHtml = blocks.map((block, index) => `
                <div class="paragraph-block">
                    <label>${index + 1}문단</label>
                    <textarea class="para-content" placeholder="${index + 1}문단 내용" required>${block.para}</textarea>
                    <div class="paragraph-q-group">
                        <input type="text" class="para-question" placeholder="이 문단의 질문" value="${block.q || ''}">
                        <input type="text" class="para-answer" placeholder="질문의 정답" value="${block.a || ''}">
                    </div>
                </div>
            `).join('');

            document.getElementById('modalBody').innerHTML = `
                <form id="editPassageForm" onsubmit="savePassage(event, ${id})">
                     <div class="form-group">
                        <label>지문 제목</label>
                        <input type="text" id="editPassageTitle" value="${passage.title}" required>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>카테고리</label>
                            <select id="editPassageCategory">
                                <option value="비문학" ${passage.category === '비문학' ? 'selected' : ''}>비문학</option>
                                <option value="문학" ${passage.category === '문학' ? 'selected' : ''}>문학</option>
                                <option value="문법" ${passage.category === '문법' ? 'selected' : ''}>문법</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>난이도</label>
                            <select id="editPassageDifficulty">
                                <option value="중학교" ${passage.difficulty === '중학교' ? 'selected' : ''}>중학교</option>
                                <option value="고1-2" ${passage.difficulty === '고1-2' ? 'selected' : ''}>고1-2</option>
                                <option value="고3" ${passage.difficulty === '고3' ? 'selected' : ''}>고3</option>
                            </select>
                        </div>
                    </div>
                    <hr style="margin: 20px 0;">
                    <label style="font-weight: 600; font-size: 1.1em; margin-bottom: 15px; display:block;">문단별 내용 및 질문</label>
                    <div id="editPassageParagraphsContainer">
                        ${paragraphsHtml}
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addEditParagraphField()">문단 추가</button>
                    <button type="submit" class="btn btn-primary">지문 저장</button>
                </form>
            `;
            document.getElementById('editModal').classList.add('active');
        }

        // (수정 모달용) 문단 추가
        function addEditParagraphField() {
             const container = document.getElementById('editPassageParagraphsContainer');
             const newIndex = container.children.length + 1;

             const div = document.createElement('div');
             div.className = 'paragraph-block';
             div.innerHTML = `
                 <label>${newIndex}문단</label>
                 <textarea class="para-content" placeholder="${newIndex}문단 내용을 입력하세요." required></textarea>
                 <div class="paragraph-q-group">
                     <input type="text" class="para-question" placeholder="이 문단의 질문">
                     <input type="text" class="para-answer" placeholder="질문의 정답">
                 </div>
             `;
             container.appendChild(div);
         }


        // 지문 수정 저장
        async function savePassage(e, id) {
            e.preventDefault();
            const passageIndex = sheetDB.passages.findIndex(p => p.id == id);
            if (passageIndex === -1) {
                 alert("수정할 지문을 찾을 수 없습니다.");
                 return;
            }

            const contentBlocks = [];
            const paraBlocks = document.querySelectorAll('#editPassageParagraphsContainer .paragraph-block');

            for(let block of paraBlocks) {
                const para = block.querySelector('.para-content').value;
                const q = block.querySelector('.para-question').value;
                const a = block.querySelector('.para-answer').value;

                if (para) {
                    contentBlocks.push({ para, q, a });
                }
            }

            if (contentBlocks.length === 0) {
                alert('하나 이상의 문단 내용을 입력해야 합니다.');
                return;
            }

             const updatedPassageData = {
                 id: id, 
                 title: document.getElementById('editPassageTitle').value,
                 category: document.getElementById('editPassageCategory').value,
                 difficulty: document.getElementById('editPassageDifficulty').value,
                 contentBlocks: contentBlocks
             };


            try {
                 await callWebApp('savePassage', updatedPassageData, 'POST');
                 
                 sheetDB.passages[passageIndex] = { ...updatedPassageData, createdAt: sheetDB.passages[passageIndex].createdAt }; 

                 loadPassageList(); 
                 closeModal();
                 alert('지문이 수정되었습니다.');
             } catch (error) {
                 alert("지문 저장 중 오류 발생: " + error.message);
             }
        }


        // 지문 삭제
        async function deletePassage(id) {
            const passageTitle = sheetDB.passages.find(p => p.id == id)?.title || id;
            if (confirm(`'${passageTitle}' 지문을 정말 삭제하시겠습니까?\n(연결된 문제도 모두 삭제됩니다)`)) {
                 try {
                     await callWebApp('deletePassage', { id: id }, 'POST');
                     
                     sheetDB.passages = sheetDB.passages.filter(p => p.id != id);
                     sheetDB.questions = sheetDB.questions.filter(q => q.passageId != id); 

                     loadPassageList(); 
                     loadQuestionPassages(); 
                     loadQuestionList(); 
                     updateTeacherDashboard(); 

                     console.log(`지문(${id})이 삭제되었습니다.`);
                 } catch (error) {
                     alert("지문 삭제 중 오류 발생: " + error.message);
                 }
            }
        }

        // 문제용 지문 목록 로드
        function loadQuestionPassages() {
            const select = document.getElementById('questionPassage');
             const options = sheetDB.passages.map(p =>
                `<option value="${p.id}">${p.title}</option>`
            ).join('');
            select.innerHTML = '<option value="none" selected>없음 (문법/개념 문제)</option>' + options;
        }

        // 문제 유형(객관식)에 따른 선택지 보이기/숨기기
        function toggleQuestionOptions() {
            const type = document.getElementById('questionType').value;
            document.getElementById('optionsContainer').style.display = (type === '객관식') ? 'flex' : 'none';
            document.getElementById('optionsContainer').style.flexDirection = 'column';
        }
        
        // 문제 등록 폼 초기화
        function resetQuestionForm() {
            document.getElementById('questionForm').reset();
            document.getElementById('editingQuestionId').value = '';
            document.getElementById('questionPassage').disabled = false;
            document.querySelector('#questionForm button[type="submit"]').textContent = '문제 저장';
            toggleQuestionOptions();
        }

        // 문제 추가 (및 수정)
        async function addQuestion(e) {
             e.preventDefault();

             const editingId = document.getElementById('editingQuestionId').value;
             const passageIdVal = document.getElementById('questionPassage').value;

             const questionData = {
                 passageId: passageIdVal === 'none' ? null : parseInt(passageIdVal),
                 type: document.getElementById('questionType').value,
                 text: document.getElementById('questionText').value,
                 answer: document.getElementById('answer').value,
                 explanation: document.getElementById('explanation').value,
                 options: [] 
             };

             if (questionData.type === '객관식') {
                 questionData.options = [
                     document.getElementById('option1').value,
                     document.getElementById('option2').value,
                     document.getElementById('option3').value,
                     document.getElementById('option4').value,
                     document.getElementById('option5').value
                 ].filter(opt => opt); 
             }

             try {
                 if (editingId) {
                     questionData.id = parseInt(editingId); 
                     await callWebApp('saveQuestion', questionData, 'POST');

                     const qIndex = sheetDB.questions.findIndex(q => q.id == editingId);
                     if (qIndex > -1) {
                         sheetDB.questions[qIndex] = questionData;
                     }
                     alert('문제가 수정되었습니다.');

                 } else {
                     questionData.id = Date.now(); 
                     await callWebApp('addQuestion', questionData, 'POST');

                     sheetDB.questions.push(questionData);
                     alert('문제가 등록되었습니다.');
                 }

                 resetQuestionForm();
                 loadQuestionList(); 
                 updateTeacherDashboard(); 

             } catch (error) {
                 alert(`문제 ${editingId ? '수정' : '등록'} 중 오류 발생: ` + error.message);
             }
         }


        // 문제 목록 로드
        function loadQuestionList() {
            const tbody = document.getElementById('questionList');
            const html = sheetDB.questions.map(q => {
                const passage = sheetDB.passages.find(p => p.id == q.passageId); 
                
                return `
                    <tr>
                        <td>${passage ? passage.title : '문법/개념'}</td>
                        <td>${q.text.substring(0, 30)}...</td>
                        <td>${q.type}</td>
                        <td>${q.answer}</td>
                        <td>
                            <button class="btn btn-warning" onclick="editQuestion(${q.id})" style="font-size: 0.9em; padding: 5px 10px;">수정</button>
                            <button class="btn btn-danger" onclick="deleteQuestion(${q.id})" style="font-size: 0.9em; padding: 5px 10px;">삭제</button>
                        </td>
                    </tr>
                `;
            }).join('');
            tbody.innerHTML = html || '<tr><td colspan="5">등록된 문제가 없습니다.</td></tr>';
        }

        // 문제 수정 폼 채우기
        function editQuestion(id) {
            const q = sheetDB.questions.find(q => q.id == id);
            if (!q) return;

            document.getElementById('editingQuestionId').value = q.id;
            document.getElementById('questionPassage').value = q.passageId === null || q.passageId === '' ? 'none' : q.passageId; 
            document.getElementById('questionPassage').disabled = true;
            document.getElementById('questionType').value = q.type;
            document.getElementById('questionText').value = q.text;
            document.getElementById('answer').value = q.answer;
            document.getElementById('explanation').value = q.explanation || '';

            toggleQuestionOptions(); 

            let options = [];
             if(typeof q.options === 'string') {
                try { options = JSON.parse(q.options); } catch(e) {}
             } else if (Array.isArray(q.options)) {
                options = q.options;
             }

            if (q.type === '객관식') {
                 document.getElementById('option1').value = options[0] || '';
                 document.getElementById('option2').value = options[1] || '';
                 document.getElementById('option3').value = options[2] || '';
                 document.getElementById('option4').value = options[3] || '';
                 document.getElementById('option5').value = options[4] || '';
             } else {
                 document.getElementById('option1').value = '';
                 document.getElementById('option2').value = '';
                 document.getElementById('option3').value = '';
                 document.getElementById('option4').value = '';
                 document.getElementById('option5').value = '';
             }


            document.querySelector('#questionForm button[type="submit"]').textContent = '수정 완료';
            window.scrollTo(0, 0);
        }

        // 문제 삭제
        async function deleteQuestion(id) {
            if (confirm('정말 삭제하시겠습니까?')) {
                 try {
                     await callWebApp('deleteQuestion', { id: id }, 'POST');
                     
                     sheetDB.questions = sheetDB.questions.filter(q => q.id != id);

                     loadQuestionList(); 
                     updateTeacherDashboard(); 

                     console.log(`문제(${id})가 삭제되었습니다.`);
                 } catch (error) {
                     alert("문제 삭제 중 오류 발생: " + error.message);
                 }
            }
        }


        // 성적 조회
        function loadResults() {
            const tbody = document.getElementById('resultsList');
            const html = sheetDB.results.map(r => {
                 const student = sheetDB.students.find(s => s.studentId == r.studentId);
                 const passage = sheetDB.passages.find(p => p.id == r.passageId);
                return `
                    <tr>
                        <td>${r.studentId}</td>
                        <td>${student ? student.name : '-'}</td>
                        <td>${passage ? passage.title : '문법/개념'}</td>
                        <td>${r.readingTime || '-'}</td>
                         <td>${r.score !== null && r.score !== '' ? Number(r.score) + '%' : 'N/A'}</td>
                        <td>${r.submittedAt}</td>
                        <td>
                            <button class="btn btn-info" onclick="viewDetail('${r.id}')" style="font-size: 0.9em; padding: 5px 10px;">상세</button>
                        </td>
                    </tr>
                `;
            }).join('');
            tbody.innerHTML = html || '<tr><td colspan="7">제출된 성적이 없습니다.</td></tr>';
        }

        // 성적 상세 보기
        function viewDetail(id) {
             const result = sheetDB.results.find(r => r.id == id);
             if (!result) return;

             const student = sheetDB.students.find(s => s.studentId == result.studentId);
             const passage = sheetDB.passages.find(p => p.id == result.passageId);

            document.getElementById('modalTitle').textContent = `${student?.name || '알수없음'} 학생 성적 상세`;

             let answers = [];
             if(typeof result.answers === 'string') {
                 try { answers = JSON.parse(result.answers); } catch(e) {}
             } else if (Array.isArray(result.answers)) {
                 answers = result.answers;
             }


             const answersHtml = answers.map(a => {
                 const q = sheetDB.questions.find(q => q.id == a.questionId);
                 const isCorrect = String(a.correct).toUpperCase() === 'TRUE';
                 return `
                     <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                         <strong>문제:</strong> ${q ? q.text : '삭제된 문제'}<br>
                         <strong>학생 답:</strong> ${a.userAnswer}<br>
                         <strong>정답:</strong> ${q ? q.answer : '-'}<br>
                         <strong>결과:</strong> ${isCorrect ? '정답' : '오답'}
                     </div>
                 `;
             }).join('');


            document.getElementById('modalBody').innerHTML = `
                 <p><strong>지문:</strong> ${passage ? passage.title : '문법/개념'}</p>
                 <p><strong>독해 시간:</strong> ${result.readingTime || '-'}</p>
                 <p><strong>점수:</strong> ${Number(result.score)}%</p>
                 <h4 style="margin-top: 20px;">답안 상세</h4>
                 ${answersHtml || '<p>답안 정보가 없습니다.</p>'}
            `;
            document.getElementById('editModal').classList.add('active');
        }

        // 통계 로드 (미구현)
        function loadStatistics() { }

        // 학생 대시보드 업데이트
        function updateStudentDashboard() {
             const myResults = sheetDB.results.filter(r => r.studentId == currentUser.studentId);
             const myScoredResults = myResults.filter(r => r.score !== null && r.score !== ''); 

             document.getElementById('myTotalStudy').textContent = myResults.length;

             if (myScoredResults.length > 0) {
                 const avgScore = myScoredResults.reduce((sum, r) => sum + Number(r.score), 0) / myScoredResults.length;
                 document.getElementById('myAvgScore').textContent = Math.round(avgScore) + '%';
             } else {
                 document.getElementById('myAvgScore').textContent = '0%';
             }

            const times = myResults.filter(r => r.readingTime).map(r => {
                const parts = String(r.readingTime).split(':'); 
                if (parts.length === 2) {
                     const [min, sec] = parts.map(Number);
                     return min * 60 + sec;
                }
                return 0; 
            });
            if (times.length > 0) {
                const totalTime = times.reduce((sum, t) => sum + t, 0);
                if (totalTime > 0) {
                    const avgTime = totalTime / times.length;
                    const minutes = Math.floor(avgTime / 60);
                    const seconds = Math.floor(avgTime % 60);
                    document.getElementById('myAvgTime').textContent = `${minutes}분 ${seconds}초`;
                } else {
                     document.getElementById('myAvgTime').textContent = `0분 0초`;
                }
            } else {
                document.getElementById('myAvgTime').textContent = `0분 0초`;
            }
        }


        // 독해 시작
        function startReading() {
            const passages = sheetDB.passages.filter(p => p.category === '비문학');
            if (passages.length === 0) {
                alert('아직 등록된 비문학 지문이 없습니다.');
                return;
            }

            currentPassage = passages[Math.floor(Math.random() * passages.length)];
             let blocks = [];
             if (typeof currentPassage.contentBlocks === 'string') {
                 try { blocks = JSON.parse(currentPassage.contentBlocks); } catch (e) { blocks = []; }
             } else {
                 blocks = currentPassage.contentBlocks || [];
             }
             currentPassage.contentBlocks = blocks;


            document.getElementById('readingArea').style.display = 'block';

            const fullPassageHtml = blocks.map(b => `<p>${b.para}</p>`).join('');
            document.getElementById('readingPassage').innerHTML = `
                <h4>${currentPassage.title}</h4>
                ${fullPassageHtml}
            `;

            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
        }

        // 타이머 업데이트
        function updateTimer() {
             const elapsed = Math.floor((Date.now() - startTime) / 1000);
             const minutes = Math.floor(elapsed / 60);
             const seconds = elapsed % 60;
             document.getElementById('timer').textContent =
                 `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // 독해 완료
        function finishReading() {
             clearInterval(timerInterval);
             const readingTime = document.getElementById('timer').textContent;
             sessionStorage.setItem('readingTime', readingTime);

             document.getElementById('readingArea').style.display = 'none';

             const paragraphQuestions = (currentPassage.contentBlocks || []).filter(b => b.q && b.q.trim() !== '');

             if (paragraphQuestions.length > 0) {
                 document.getElementById('paragraphQuizArea').style.display = 'block';

                 const keywordHtml = paragraphQuestions.map((b, idx) => `
                     <div class="form-group">
                         <label>${b.q}</label>
                         <input type="text" id="keyword_answer_${idx}" class="form-group" style="width: 100%;">
                     </div>
                 `).join('');

                 document.getElementById('paragraphQuizContainer').innerHTML = keywordHtml;

             } else {
                 showMainQuiz();
             }
        }


        // 문단별 퀴즈 제출
        function submitParagraphQuiz() {
             document.getElementById('paragraphQuizArea').style.display = 'none';
             showMainQuiz();
        }

        // 메인 퀴즈 표시 함수
        async function showMainQuiz() {
            const questions = sheetDB.questions.filter(q => q.passageId == currentPassage.id);

            if (questions.length === 0) {
                alert('이 지문에 대한 문제가 없습니다. 학습을 종료합니다.');
                resetStudy();
                const result = {
                    id: Date.now(),
                    studentId: currentUser.studentId,
                    passageId: currentPassage.id,
                    readingTime: sessionStorage.getItem('readingTime') || null,
                    score: null,
                    answers: [],
                    submittedAt: new Date().toLocaleString()
                };
                 try {
                     await callWebApp('addResult', result, 'POST');
                     sheetDB.results.push(result); 
                     sessionStorage.removeItem('readingTime');
                 } catch (error) {
                     alert("결과 저장 중 오류 발생: " + error.message);
                 }
                return;
            }

            currentQuestions = questions;

            document.getElementById('quizArea').style.display = 'block';

            const quizHtml = questions.map((q, idx) => {
                 let options = [];
                 if(typeof q.options === 'string') {
                    try { options = JSON.parse(q.options); } catch(e) {}
                 } else if (Array.isArray(q.options)) {
                    options = q.options;
                 }
                 return `
                    <div class="question-card">
                        <span class="question-number">${idx + 1}</span>
                        <span>${q.text}</span>
                        ${q.type === '객관식' ? `
                            <div class="options">
                                ${options.map((opt, i) => `
                                    <label class="option">
                                        <input type="radio" name="q${idx}" value="${i + 1}">
                                        ${i + 1}. ${opt}
                                    </label>
                                `).join('')}
                            </div>
                        ` : `
                            <input type="text" id="answer${idx}" class="form-control" style="margin-top: 10px;">
                        `}
                    </div>
                `}).join('');

            document.getElementById('quizContainer').innerHTML = quizHtml;
        }


        // 문제 풀기 시작 (문법/개념)
        function startQuiz() {
            const standaloneQuestions = sheetDB.questions.filter(q => q.passageId === null || q.passageId === ''); 

            if (standaloneQuestions.length === 0) {
                alert('아직 등록된 문법/개념 문제가 없습니다.');
                return;
            }

            const questionCount = Math.min(5, standaloneQuestions.length);
            currentQuestions = standaloneQuestions.sort(() => 0.5 - Math.random()).slice(0, questionCount);
            currentPassage = null; 

            document.getElementById('quizArea').style.display = 'block';

             const quizHtml = currentQuestions.map((q, idx) => {
                 let options = [];
                 if(typeof q.options === 'string') {
                    try { options = JSON.parse(q.options); } catch(e) {}
                 } else if (Array.isArray(q.options)) {
                    options = q.options;
                 }

                return `
                    <div class="question-card">
                        <span class="question-number">${idx + 1}</span>
                        <span>${q.text}</span>
                        ${q.type === '객관식' ? `
                            <div class="options">
                                ${options.map((opt, i) => `
                                    <label class="option">
                                        <input type="radio" name="q${idx}" value="${i + 1}">
                                        ${i + 1}. ${opt}
                                    </label>
                                `).join('')}
                            </div>
                        ` : `
                            <input type="text" id="answer${idx}" class="form-control" style="margin-top: 10px;">
                        `}
                    </div>
            `}).join('');

            document.getElementById('quizContainer').innerHTML = quizHtml;
        }

        // 퀴즈 제출
        async function submitQuiz() {
             let correctCount = 0;
             const answers = []; 

             currentQuestions.forEach((q, idx) => {
                 let userAnswer = '';
                 const correctAnswer = String(q.answer); 

                 if (q.type === '객관식') {
                     const selected = document.querySelector(`input[name="q${idx}"]:checked`);
                     userAnswer = selected ? selected.value : '';
                 } else {
                     userAnswer = document.getElementById(`answer${idx}`).value;
                 }

                 const isCorrect = userAnswer === correctAnswer;
                 answers.push({
                     questionId: q.id,
                     userAnswer,
                     correct: isCorrect 
                 });

                 if (isCorrect) {
                     correctCount++;
                 }
             });

            const score = currentQuestions.length > 0 ? Math.round((correctCount / currentQuestions.length) * 100) : 0;

            const result = {
                id: Date.now(),
                studentId: currentUser.studentId,
                passageId: currentPassage ? currentPassage.id : null,
                readingTime: sessionStorage.getItem('readingTime') || null,
                score,
                 answers: answers, 
                submittedAt: new Date().toLocaleString()
            };

             try {
                 await callWebApp('addResult', result, 'POST');
                 
                  sheetDB.results.push(result);

                 document.getElementById('quizArea').style.display = 'none';
                 document.getElementById('resultArea').style.display = 'block';
                 document.getElementById('score').textContent = score + '점';

                 let message = '';
                 if (score >= 90) message = '🎉 훌륭합니다! 완벽한 이해력을 보여주었네요!';
                 else if (score >= 80) message = '👍 잘했습니다! 좋은 이해력을 가지고 있네요!';
                 else if (score >= 70) message = '😊 괜찮습니다! 조금만 더 노력하면 됩니다!';
                 else if (score >= 60) message = '💪 힘내세요! 꾸준히 연습하면 실력이 늘어요!';
                 else message = '📚 더 연습이 필요해요. 다시 도전해보세요!';
                 document.getElementById('resultMessage').textContent = message;

                 sessionStorage.removeItem('readingTime');

             } catch (error) {
                 alert("결과 저장 중 오류 발생: " + error.message);
             }
        }


        // 학습 초기화
        function resetStudy() {
             document.getElementById('resultArea').style.display = 'none';
             document.getElementById('readingArea').style.display = 'none';
             document.getElementById('quizArea').style.display = 'none';
             document.getElementById('paragraphQuizArea').style.display = 'none';
             currentPassage = null;
             currentQuestions = [];
        }

        // 내 성적 로드
        function loadMyResults() {
             const myResults = sheetDB.results.filter(r => r.studentId == currentUser.studentId);

             const tbody = document.getElementById('myStudyHistory');
             const html = myResults.map(r => {
                 const passage = sheetDB.passages.find(p => p.id == r.passageId);
                 const scoreDisplay = (r.score !== null && r.score !== '') ? Number(r.score) + '%' : 'N/A';
                 let statusHtml = '';
                 if (r.score === null || r.score === '') {
                     statusHtml = '<span style="color: gray;">독해</span>';
                 } else {
                     statusHtml = Number(r.score) >= 80 ?
                         '<span style="color: green;">우수</span>' :
                         '<span style="color: orange;">노력필요</span>';
                 }

                 return `
                     <tr>
                         <td>${r.submittedAt}</td>
                         <td>${passage ? passage.title : '문법/개념'}</td>
                         <td>${r.readingTime || '-'}</td>
                         <td>${scoreDisplay}</td>
                         <td>${statusHtml}</td>
                     </tr>
                 `;
             }).join('');
             tbody.innerHTML = html || '<tr><td colspan="5">학습 이력이 없습니다.</td></tr>';

             updateStudentDashboard();
         }


        // 순위 로드
        function loadRanking() {
             const studentScores = {};

             sheetDB.students.forEach(s => {
                 const results = sheetDB.results.filter(r => r.studentId == s.studentId && r.score !== null && r.score !== '');
                 if (results.length > 0) {
                     const avgScore = results.reduce((sum, r) => sum + Number(r.score), 0) / results.length;
                     studentScores[s.studentId] = {
                         ...s,
                         avgScore: Math.round(avgScore),
                         studyCount: results.length
                     };
                 }
             });

             const ranking = Object.values(studentScores).sort((a, b) => b.avgScore - a.avgScore);

             const myRankIndex = ranking.findIndex(s => s.studentId == currentUser.studentId);
             const myRank = myRankIndex > -1 ? myRankIndex + 1 : '-';
             document.getElementById('myRank').textContent = myRank > 0 ? myRank + '위' : '-';


             const tbody = document.getElementById('rankingList');
             const html = ranking.map((s, idx) => `
                 <tr ${s.studentId == currentUser.studentId ? 'style="background: #e8eaf6;"' : ''}>
                     <td>${idx + 1}위</td>
                     <td>${s.studentId}</td>
                     <td>${s.name}</td>
                     <td>${s.avgScore}%</td>
                     <td>${s.studyCount}회</td>
                 </tr>
             `).join('');
             tbody.innerHTML = html || '<tr><td colspan="5">순위 정보가 없습니다.</td></tr>';
         }

        // 모달 닫기
        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('userType').addEventListener('change', toggleStudentFields);
            document.getElementById('questionType').addEventListener('change', toggleQuestionOptions);

            toggleStudentFields(); 

            await loadInitialData(); 

            document.getElementById('loginPage').style.display = 'flex';
            loadingOverlay.classList.remove('active'); 
        });
       
    </script>
</body>
</html>